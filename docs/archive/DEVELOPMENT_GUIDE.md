# å°çº¢ä¹¦è‡ªåŠ¨å‘å¸ƒå·¥å…· - é¡¹ç›®å¼€å‘æ–‡æ¡£

> åŸºäºéœ€æ±‚æ–‡æ¡£ v2.0 ç¼–å†™ | é¡¹ç›®ä»£å·: XHS_AutoPublisher_v2
> æ–‡æ¡£ç‰ˆæœ¬: v2.1 | æœ€åæ›´æ–°: 2025-12-12

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è§ˆ](#1-é¡¹ç›®æ¦‚è§ˆ)
2. [æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
3. [å¼€å‘ç¯å¢ƒæ­å»º](#3-å¼€å‘ç¯å¢ƒæ­å»º)
4. [çˆ†æ¬¾é‡‡é›†å¹³å°å¼€å‘æŒ‡å—](#4-çˆ†æ¬¾é‡‡é›†å¹³å°å¼€å‘æŒ‡å—)
5. [N8Nå·¥ä½œæµæ¨¡å—å¼€å‘æŒ‡å—](#5-n8nå·¥ä½œæµæ¨¡å—å¼€å‘æŒ‡å—)
6. [æ•°æ®åº“è®¾è®¡ä¸å®ç°](#6-æ•°æ®åº“è®¾è®¡ä¸å®ç°)
7. [N8Nå·¥ä½œæµå¼€å‘è§„èŒƒ](#7-n8nå·¥ä½œæµå¼€å‘è§„èŒƒ)
8. [APIé›†æˆæŒ‡å—](#8-apié›†æˆæŒ‡å—)
9. [æµ‹è¯•ç­–ç•¥](#9-æµ‹è¯•ç­–ç•¥)
10. [Chromeæ‰©å±•é›†æˆæŒ‡å—](#10-chromeæ‰©å±•é›†æˆæŒ‡å—)
11. [éƒ¨ç½²ä¸è¿ç»´æŒ‡å—](#11-éƒ¨ç½²ä¸è¿ç»´æŒ‡å—)
12. [å¼€å‘é‡Œç¨‹ç¢‘](#12-å¼€å‘é‡Œç¨‹ç¢‘)

---

## 1. é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ª**å°çº¢ä¹¦å†…å®¹è‡ªåŠ¨åŒ–å¹³å°**ï¼ŒåŒ…å«ä¸¤å¤§æ ¸å¿ƒç³»ç»Ÿï¼š

#### ç³»ç»Ÿä¸€ï¼šçˆ†æ¬¾é‡‡é›†å¹³å° (Web)

ç‹¬ç«‹çš„ Web åº”ç”¨ï¼Œæä¾›çˆ†æ¬¾å†…å®¹å‘ç°ã€é‡‡é›†ã€åˆ†æèƒ½åŠ›ã€‚

| åŠŸèƒ½æ¨¡å— | æè¿° |
|---------|------|
| çˆ†æ¬¾å‘ç° | å…³é”®è¯æœç´¢ + çƒ­é—¨è¯é¢˜ + ç«å“ç›‘æ§ + ä½œè€…è¿½è¸ª |
| å†…å®¹åº“ | é‡‡é›†åˆ—è¡¨ + æ”¶è—ç®¡ç† + æ ‡ç­¾åˆ†ç±» + æ‰¹é‡å¯¼å‡º |
| æ•°æ®åˆ†æ | è¶‹åŠ¿å›¾è¡¨ + çˆ†æ¬¾è§„å¾‹ + é€‰é¢˜æ¨è + å‘¨æŠ¥ç”Ÿæˆ |
| é‡‡é›†ä»»åŠ¡ | å®šæ—¶ä»»åŠ¡ + ä»»åŠ¡é˜Ÿåˆ— + æ‰§è¡Œæ—¥å¿— + å¤±è´¥é‡è¯• |
| AI åŠ©æ‰‹ | é€‰é¢˜ç”Ÿæˆ + å†…å®¹æ”¹å†™ + çˆ†æ¬¾é¢„æµ‹ + æ ‡é¢˜ä¼˜åŒ– |

#### ç³»ç»ŸäºŒï¼šN8N å·¥ä½œæµå¼•æ“

åŸºäº N8N çš„å†…å®¹ç”Ÿäº§è‡ªåŠ¨åŒ–æµæ°´çº¿ã€‚

| åŠŸèƒ½æ¨¡å— | æè¿° |
|---------|------|
| æ™ºèƒ½é€‰é¢˜ | å…³é”®è¯ + çƒ­ç‚¹è¶‹åŠ¿ + çˆ†æ¬¾å‚è€ƒ + AIè¯„åˆ† |
| å†…å®¹ç”Ÿæˆ | Claudeå¤šé£æ ¼åˆ›ä½œ + 5æ­¥å®¡æ ¸ |
| å›¾ç‰‡ç”Ÿæˆ | Gemini API 3:4ç«–å›¾ |
| æ™ºèƒ½å‘å¸ƒ | AIå®šæ—¶ + MCPåŠè‡ªåŠ¨å‘å¸ƒ |
| æ•°æ®é—­ç¯ | é£ä¹¦å­˜å‚¨ + äº’åŠ¨æ•°æ®å›æµ |

#### ç³»ç»Ÿåä½œå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çˆ†æ¬¾é‡‡é›†å¹³å° (Next.js)                        â”‚
â”‚                                                                  â”‚
â”‚  [çˆ†æ¬¾å‘ç°] â†’ [å†…å®¹åº“] â†’ [æ•°æ®åˆ†æ] â†’ [é€‰é¢˜æ¨è]                 â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é‡‡é›†æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Webhook / API
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     N8N å·¥ä½œæµå¼•æ“                                â”‚
â”‚                                                                  â”‚
â”‚  [é€‰é¢˜å·¥ä½œæµ] â†’ [åˆ›ä½œå·¥ä½œæµ] â†’ [å‘å¸ƒå·¥ä½œæµ] â†’ [æ•°æ®å›æµå·¥ä½œæµ]    â”‚
â”‚       â†‘                                              â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•ˆæœåé¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é£ä¹¦å¤šç»´è¡¨æ ¼                                 â”‚
â”‚  [content_records] [accounts] [execution_logs] [interaction_data]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | éªŒè¯æ–¹å¼ |
|------|--------|----------|
| **çˆ†æ¬¾é‡‡é›†å¹³å°** |
| æ—¥å‡é‡‡é›†é‡ | â‰¥500æ¡ç¬”è®° | æ•°æ®åº“ç»Ÿè®¡ |
| çˆ†æ¬¾è¯†åˆ«ç‡ | â‰¥80% | äººå·¥æŠ½æ£€ |
| é‡‡é›†æˆåŠŸç‡ | â‰¥95% | ä»»åŠ¡æ—¥å¿— |
| **N8N å·¥ä½œæµ** |
| å†…å®¹ç”Ÿäº§æ•ˆç‡ | 2-3h â†’ 15min | æ—¶é—´å¯¹æ¯” |
| AIå®¡æ ¸é€šè¿‡ç‡ | â‰¥85% | 30å¤©æ•°æ®ç»Ÿè®¡ |
| ç³»ç»ŸæˆåŠŸç‡ | â‰¥90% | N8Næ‰§è¡Œæ—¥å¿— |
| å¤šè´¦å·æ”¯æŒ | 3-5ä¸ªè´¦å· | è´¦å·ç®¡ç†éªŒè¯ |

### 1.3 é¡¹ç›®ç»“æ„

é‡‡ç”¨ **Monorepo** æ¶æ„ï¼Œç»Ÿä¸€ç®¡ç†çˆ†æ¬¾é‡‡é›†å¹³å°å’Œ N8N å·¥ä½œæµã€‚

```
xiaohongshu_auto_publisher/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                              # ğŸŒ çˆ†æ¬¾é‡‡é›†å¹³å° (Next.js 14)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ app/                      # App Router
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ (dashboard)/          # ä»ªè¡¨ç›˜å¸ƒå±€ç»„
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # é¦–é¡µä»ªè¡¨ç›˜
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ discover/         # çˆ†æ¬¾å‘ç°é¡µ
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ library/          # å†…å®¹åº“é¡µ
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tasks/            # é‡‡é›†ä»»åŠ¡é¡µ
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analytics/        # æ•°æ®åˆ†æé¡µ
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ settings/         # ç³»ç»Ÿè®¾ç½®é¡µ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ api/                  # API Routes
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notes/            # ç¬”è®°ç®¡ç†æ¥å£
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ search/           # æœç´¢é‡‡é›†æ¥å£
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tasks/            # ä»»åŠ¡ç®¡ç†æ¥å£
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analytics/        # åˆ†ææ•°æ®æ¥å£
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ webhook/          # n8n å›è°ƒæ¥å£
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth/                 # è®¤è¯ç›¸å…³
â”‚   â”‚   â”‚   â”œâ”€â”€ components/               # React ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ui/                   # åŸºç¡€UI (shadcn/ui)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notes/                # ç¬”è®°ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ charts/               # å›¾è¡¨ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ layout/               # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/                      # å·¥å…·åº“
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ db/                   # Prisma æ•°æ®åº“æ“ä½œ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ crawler/              # Puppeteer é‡‡é›†å¼•æ“
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ queue/                # BullMQ ä»»åŠ¡é˜Ÿåˆ—
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ai/                   # AI é›†æˆ (Claude)
â”‚   â”‚   â”‚   â””â”€â”€ types/                    # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â””â”€â”€ schema.prisma             # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ public/                       # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”‚
â”‚   â””â”€â”€ n8n/                              # âš™ï¸ N8N å·¥ä½œæµ
â”‚       â”œâ”€â”€ workflows/                    # ä¸»å·¥ä½œæµ JSON
â”‚       â”‚   â”œâ”€â”€ content_generator_v1.json
â”‚       â”‚   â”œâ”€â”€ publish_scheduler_v1.json
â”‚       â”‚   â”œâ”€â”€ data_collector_v1.json
â”‚       â”‚   â””â”€â”€ hot_content_collector_v1.json  # æ–°å¢ï¼šçˆ†æ¬¾é‡‡é›†å·¥ä½œæµ
â”‚       â”œâ”€â”€ sub_workflows/                # å­å·¥ä½œæµ
â”‚       â”‚   â”œâ”€â”€ sub_ai_score.json
â”‚       â”‚   â”œâ”€â”€ sub_hot_topics.json
â”‚       â”‚   â”œâ”€â”€ sub_image_gen.json
â”‚       â”‚   â”œâ”€â”€ sub_publish.json
â”‚       â”‚   â””â”€â”€ sub_notify.json
â”‚       â””â”€â”€ credentials/                  # å‡­è¯é…ç½®è¯´æ˜
â”‚
â”œâ”€â”€ packages/                             # ğŸ“¦ å…±äº«åŒ…
â”‚   â”œâ”€â”€ types/                            # å…±äº«ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ note.ts                   # ç¬”è®°ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ task.ts                   # ä»»åŠ¡ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ utils/                            # å…±äº«å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ format.ts                 # æ ¼å¼åŒ–å·¥å…·
â”‚       â”‚   â”œâ”€â”€ validate.ts               # éªŒè¯å·¥å…·
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ config/                               # ğŸ”§ é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ prompts/                          # AI Prompt æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ topic_generation.md
â”‚   â”‚   â”œâ”€â”€ content_creation.md
â”‚   â”‚   â”œâ”€â”€ review_steps.md
â”‚   â”‚   â””â”€â”€ hot_analysis.md               # æ–°å¢ï¼šçˆ†æ¬¾åˆ†æ Prompt
â”‚   â”œâ”€â”€ prompt_registry.json              # Prompt ç‰ˆæœ¬æ³¨å†Œè¡¨
â”‚   â””â”€â”€ settings.json                     # ç³»ç»Ÿé…ç½®
â”‚
â”œâ”€â”€ scripts/                              # ğŸ› ï¸ è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ setup.sh                          # ç¯å¢ƒåˆå§‹åŒ–
â”‚   â”œâ”€â”€ backup.sh                         # æ•°æ®å¤‡ä»½
â”‚   â”œâ”€â”€ health_check.sh                   # å¥åº·æ£€æŸ¥
â”‚   â””â”€â”€ db-migrate.sh                     # æ•°æ®åº“è¿ç§»
â”‚
â”œâ”€â”€ tests/                                # ğŸ§ª æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ golden/                           # é‡‘æ•°æ®æµ‹è¯•é›†
â”‚   â”œâ”€â”€ regression/                       # å›å½’æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ e2e/                              # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚
â”œâ”€â”€ docker/                               # ğŸ³ Docker é…ç½®
â”‚   â”œâ”€â”€ nginx/
â”‚   â”‚   â””â”€â”€ conf.d/
â”‚   â”‚       â””â”€â”€ default.conf
â”‚   â””â”€â”€ postgres/
â”‚       â””â”€â”€ init.sql
â”‚
â”œâ”€â”€ docker-compose.yml                    # Docker ç¼–æ’
â”œâ”€â”€ docker-compose.dev.yml                # å¼€å‘ç¯å¢ƒç¼–æ’
â”œâ”€â”€ package.json                          # Monorepo æ ¹é…ç½®
â”œâ”€â”€ pnpm-workspace.yaml                   # pnpm å·¥ä½œåŒºé…ç½®
â”œâ”€â”€ turbo.json                            # Turborepo é…ç½®
â””â”€â”€ README.md
```

### 1.4 åŠŸèƒ½æ¨¡å— â†” ç³»ç»Ÿ â†” æ•°æ®è¡¨ æ˜ å°„è¡¨

æœ¬èŠ‚æä¾›åŠŸèƒ½éœ€æ±‚ä¸æŠ€æœ¯å®ç°çš„å¿«é€Ÿå¯¹ç…§ï¼Œä¾¿äºä»ä¸šåŠ¡éœ€æ±‚ç›´æ¥å®šä½åˆ°ç³»ç»Ÿç»„ä»¶å’Œæ•°æ®è¡¨ã€‚

#### 1.4.1 ä¸»æ˜ å°„è¡¨

| åŠŸèƒ½æ¨¡å— | æ‰€å±ç³»ç»Ÿ | å®ç°æ–¹å¼ | ä¸»è¦æ•°æ®è¡¨ |
|----------|----------|----------|------------|
| **çˆ†æ¬¾é‡‡é›†å¹³å°** |
| å…³é”®è¯æœç´¢é‡‡é›† | Web å¹³å° | Puppeteer + API | `notes`, `keywords`, `crawl_tasks` |
| ä½œè€…ç›‘æ§é‡‡é›† | Web å¹³å° | Puppeteer + å®šæ—¶ä»»åŠ¡ | `notes`, `authors`, `crawl_tasks` |
| å†…å®¹åº“ç®¡ç† | Web å¹³å° | Next.js + Prisma | `notes`, `collections` |
| æ•°æ®åˆ†æ | Web å¹³å° | SQL èšåˆ + å›¾è¡¨ | `notes`, `analytics_cache` |
| é‡‡é›†ä»»åŠ¡ç®¡ç† | Web å¹³å° | BullMQ é˜Ÿåˆ— | `crawl_tasks` |
| **N8N å·¥ä½œæµå¼•æ“** |
| æ™ºèƒ½é€‰é¢˜ | N8N | `content_generator_v1` | é£ä¹¦ `content_records` |
| å†…å®¹ç”Ÿæˆ+AIå®¡æ ¸ | N8N | `content_generator_v1` | é£ä¹¦ `content_records` |
| å›¾ç‰‡ç”Ÿæˆ | N8N | `sub_image_gen` | é£ä¹¦ `content_records` |
| åŠè‡ªåŠ¨å‘å¸ƒ | N8N | `publish_scheduler_v1` | é£ä¹¦ `content_records`, `accounts` |
| æ•°æ®å›æµ | N8N | `data_collector_v1` | é£ä¹¦ `interaction_data` |
| çˆ†æ¬¾æ•°æ®æ‹‰å– | N8N | `hot_content_collector_v1` | ä» Web å¹³å° API è·å– |
| **å…±äº«åŠŸèƒ½** |
| è´¦å· Cookie ç®¡ç† | Web å¹³å° | åŠ å¯†å­˜å‚¨ | `xhs_accounts` |
| æ—¥å¿—ä¸ç›‘æ§ | ä¸¤ä¸ªç³»ç»Ÿ | å„è‡ªè®°å½• | `crawl_tasks` / é£ä¹¦ `execution_logs` |

#### 1.4.2 æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           çˆ†æ¬¾é‡‡é›†å¹³å°æ•°æ®æµ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  [ç”¨æˆ·æœç´¢/å®šæ—¶ä»»åŠ¡] â”€â”€â†’ [Puppeteer é‡‡é›†å¼•æ“] â”€â”€â†’ [å°çº¢ä¹¦æœç´¢é¡µ/ä½œè€…é¡µ]      â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â†“                                          â”‚
â”‚                          [è§£æç¬”è®°æ•°æ®]                                      â”‚
â”‚                                   â”‚                                          â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                     â†“             â†“             â†“                           â”‚
â”‚              [PostgreSQL]   [Redisç¼“å­˜]   [BullMQé˜Ÿåˆ—]                      â”‚
â”‚              notes è¡¨       çƒ­é—¨æ•°æ®ç¼“å­˜   ä»»åŠ¡çŠ¶æ€                          â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â†“                                                        â”‚
â”‚              [API æ¥å£] â†â”€â”€ GET /api/notes/hot â†â”€â”€ [N8N å·¥ä½œæµ]             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           N8N å·¥ä½œæµæ•°æ®æµ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  [é€‰é¢˜è§¦å‘] â”€â”€â†’ hot_content_collector_v1 â”€â”€â†’ ä» Web å¹³å°æ‹‰å–çˆ†æ¬¾æ•°æ®        â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â†“                                                   â”‚
â”‚                content_generator_v1 â”€â”€â†’ é£ä¹¦ content_records (DRAFT)        â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â”œâ”€â†’ sub_hot_topics â”€â”€â†’ execution_logs              â”‚
â”‚                          â”œâ”€â†’ sub_ai_score â”€â”€â†’ content_records (AI_REVIEWED) â”‚
â”‚                          â””â”€â†’ sub_image_gen â”€â”€â†’ content_records.image_url    â”‚
â”‚                                                                              â”‚
â”‚  [å‘å¸ƒè§¦å‘] â”€â”€â†’ publish_scheduler_v1 â”€â”€â†’ accounts (é™é¢‘æ£€æŸ¥)                â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â”œâ”€â†’ sub_publish â”€â”€â†’ content_records (PUBLISHED)    â”‚
â”‚                          â””â”€â†’ sub_notify â”€â”€â†’ Telegram                        â”‚
â”‚                                                                              â”‚
â”‚  [æ•°æ®å›æµ] â”€â”€â†’ data_collector_v1 â”€â”€â†’ interaction_data                      â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â””â”€â†’ content_records (real_score, prediction_error) â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.3 çŠ¶æ€ä¸å·¥ä½œæµå¯¹åº”

| å†…å®¹çŠ¶æ€ | äº§ç”Ÿè¯¥çŠ¶æ€çš„å·¥ä½œæµ/èŠ‚ç‚¹ | åç»­å¯è§¦å‘çš„å·¥ä½œæµ |
|----------|------------------------|-------------------|
| `DRAFT` | `content_generator_v1` / Generate_Content | (åŒå·¥ä½œæµå†…) AI_Review |
| `AI_REVIEWED` | `content_generator_v1` / AI_Gateway(score) | `publish_scheduler_v1` |
| `REJECTED` | `content_generator_v1` / Branch_By_Score | æ— ï¼ˆç»ˆæ€ï¼‰ |
| `PENDING_APPROVAL` | äººå·¥å®¡æ ¸é€šè¿‡ | `publish_scheduler_v1` |
| `PUBLISHING` | `publish_scheduler_v1` / XHS_MCP_Publish | (åŒå·¥ä½œæµå†…) |
| `PUBLISHED` | `publish_scheduler_v1` / Publish_Success | `data_collector_v1` |
| `FAILED` | `publish_scheduler_v1` / Publish_Fail | äººå·¥ä»‹å…¥åé‡è¯• |

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 ç”¨æˆ·å±‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  çˆ†æ¬¾é‡‡é›†å¹³å° (Web UI)   â”‚  â”‚ Telegram Bot â”‚  â”‚      é£ä¹¦å¤šç»´è¡¨æ ¼       â”‚  â”‚
â”‚  â”‚  - çˆ†æ¬¾å‘ç°/æœç´¢        â”‚  â”‚  - é€šçŸ¥æ¨é€  â”‚  â”‚  - å†…å®¹ç®¡ç†/å®¡æ ¸        â”‚  â”‚
â”‚  â”‚  - å†…å®¹åº“ç®¡ç†           â”‚  â”‚  - æŒ‡ä»¤æ“ä½œ  â”‚  â”‚  - æ•°æ®æŸ¥çœ‹            â”‚  â”‚
â”‚  â”‚  - æ•°æ®åˆ†æä»ªè¡¨ç›˜       â”‚  â”‚              â”‚  â”‚                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              åº”ç”¨å±‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     çˆ†æ¬¾é‡‡é›†å¹³å° (Next.js 14)    â”‚  â”‚        N8N å·¥ä½œæµå¼•æ“            â”‚   â”‚
â”‚  â”‚                                 â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ API Routesâ”‚ â”‚  é‡‡é›†å¼•æ“  â”‚   â”‚  â”‚  â”‚ é€‰é¢˜å·¥ä½œæµ â”‚ â”‚ åˆ›ä½œå·¥ä½œæµ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ /api/*   â”‚ â”‚ Puppeteer â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚ å‘å¸ƒå·¥ä½œæµ â”‚ â”‚ æ•°æ®å·¥ä½œæµ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ä»»åŠ¡é˜Ÿåˆ—  â”‚ â”‚  AI åˆ†æ  â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”‚  BullMQ   â”‚ â”‚  Claude   â”‚   â”‚  â”‚         â†“                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  [AI Gateway - ç»Ÿä¸€è°ƒåº¦]        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                    â”‚                   â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Webhook / API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               æœåŠ¡å±‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Claude API â”‚ â”‚Gemini API â”‚ â”‚  é£ä¹¦ API  â”‚ â”‚å°çº¢ä¹¦ MCP â”‚ â”‚Telegram Botâ”‚     â”‚
â”‚  â”‚é€‰é¢˜/åˆ›ä½œ   â”‚ â”‚ å›¾ç‰‡ç”Ÿæˆ  â”‚ â”‚ æ•°æ®å­˜å‚¨   â”‚ â”‚ åŠè‡ªåŠ¨å‘å¸ƒ â”‚ â”‚  çŠ¶æ€æ¨é€  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               æ•°æ®å±‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     PostgreSQL      â”‚  â”‚        Redis        â”‚  â”‚     æ–‡ä»¶å­˜å‚¨         â”‚  â”‚
â”‚  â”‚  - é‡‡é›†ç¬”è®°æ•°æ®     â”‚  â”‚  - ç¼“å­˜/ä¼šè¯        â”‚  â”‚  - å›¾ç‰‡/å¯¼å‡ºæ–‡ä»¶     â”‚  â”‚
â”‚  â”‚  - ä»»åŠ¡è®°å½•        â”‚  â”‚  - BullMQ é˜Ÿåˆ—       â”‚  â”‚  - å¤‡ä»½æ•°æ®         â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·é…ç½®        â”‚  â”‚  - çƒ­é—¨æ•°æ®ç¼“å­˜      â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              åŸºç¡€è®¾æ–½å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [Ubuntu 22.04] + [Docker Compose] + [Nginx] + [Let's Encrypt]      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç»„ä»¶æ¸…å•

#### çˆ†æ¬¾é‡‡é›†å¹³å°ç»„ä»¶

| ç»„ä»¶ | é€‰å‹ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|------|------|----------|------|
| å‰ç«¯æ¡†æ¶ | Next.js | 14.x | App Router + React Server Components |
| UI ç»„ä»¶åº“ | shadcn/ui | latest | åŸºäº Radix UI çš„ç»„ä»¶åº“ |
| æ ·å¼æ–¹æ¡ˆ | Tailwind CSS | 3.4+ | åŸå­åŒ– CSS |
| å›¾è¡¨åº“ | Recharts | 2.x | æ•°æ®å¯è§†åŒ– |
| ORM | Prisma | 5.x | æ•°æ®åº“æ“ä½œ |
| é‡‡é›†å¼•æ“ | Puppeteer | 22.x | æ— å¤´æµè§ˆå™¨é‡‡é›† |
| ä»»åŠ¡é˜Ÿåˆ— | BullMQ | 5.x | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| æ•°æ®åº“ | PostgreSQL | 15+ | ä¸»æ•°æ®å­˜å‚¨ |
| ç¼“å­˜/é˜Ÿåˆ— | Redis | 7+ | ç¼“å­˜ + é˜Ÿåˆ—åç«¯ |

#### N8N å·¥ä½œæµç»„ä»¶

| ç»„ä»¶ | é€‰å‹ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|------|------|----------|------|
| ç¼–æ’å¼•æ“ | N8N | â‰¥1.20 | å·¥ä½œæµè°ƒåº¦ |
| LLM | Claude API | claude-sonnet-4 | é€‰é¢˜/åˆ›ä½œ/å®¡æ ¸ |
| å›¾ç‰‡ç”Ÿæˆ | Gemini API | gemini-2.0 | 3:4ç«–å›¾ |
| æ•°æ®å­˜å‚¨ | é£ä¹¦å¤šç»´è¡¨æ ¼ | - | ç»“æ„åŒ–æ•°æ® |
| å‘å¸ƒé€šé“ | å°çº¢ä¹¦MCP | - | åŠè‡ªåŠ¨å‘å¸ƒ |
| é€šçŸ¥æœåŠ¡ | Telegram Bot | - | çŠ¶æ€æ¨é€ |

#### åŸºç¡€è®¾æ–½ç»„ä»¶

| ç»„ä»¶ | é€‰å‹ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|------|------|----------|------|
| æ“ä½œç³»ç»Ÿ | Ubuntu | 22.04 LTS | æœåŠ¡å™¨ç³»ç»Ÿ |
| å®¹å™¨åŒ– | Docker | 24+ | åº”ç”¨å®¹å™¨åŒ– |
| ç¼–æ’å·¥å…· | Docker Compose | 2.x | å¤šå®¹å™¨ç¼–æ’ |
| åå‘ä»£ç† | Nginx | latest | è´Ÿè½½å‡è¡¡ + SSL |
| SSLè¯ä¹¦ | Let's Encrypt | - | HTTPS åŠ å¯† |

### 2.3 æ•°æ®æµå›¾

```
[å®šæ—¶è§¦å‘/æ‰‹åŠ¨è§¦å‘]
        â†“
[1. æ™ºèƒ½é€‰é¢˜æ¨¡å—]
   â”œâ”€ è¯»å–é…ç½®(é£ä¹¦)
   â”œâ”€ AIç”Ÿæˆé€‰é¢˜(Claude)
   â”œâ”€ æŠ“å–çƒ­ç‚¹(Web Scraper)
   â”œâ”€ è¯­ä¹‰åŒ¹é…
   â””â”€ AIè¯„åˆ†æ’åº
        â†“
[2. å†…å®¹åˆ›ä½œæ¨¡å—]
   â”œâ”€ AIç”Ÿæˆå†…å®¹(Claude)
   â”œâ”€ 5æ­¥AIå®¡æ ¸
   â”œâ”€ è®¡ç®—ç»¼åˆè¯„åˆ†
   â””â”€ åˆ†æ”¯åˆ¤æ–­(é€šè¿‡/ä¼˜åŒ–/æ‹’ç»)
        â†“
[3. å›¾ç‰‡ç”Ÿæˆæ¨¡å—]
   â”œâ”€ ç”Ÿæˆå›¾ç‰‡Prompt(Claude)
   â”œâ”€ ç”Ÿæˆå›¾ç‰‡(Gemini)
   â””â”€ å­˜å‚¨å›¾ç‰‡
        â†“
[4. äººå·¥å®¡æ ¸é˜Ÿåˆ—]
   â”œâ”€ Telegramé€šçŸ¥
   â””â”€ é£ä¹¦è¡¨æ ¼æ›´æ–°
        â†“
[5. å‘å¸ƒæ¨¡å—]
   â”œâ”€ æ£€æŸ¥è´¦å·çŠ¶æ€
   â”œâ”€ é™é¢‘æ£€æŸ¥
   â”œâ”€ MCPå‘å¸ƒ
   â””â”€ è®°å½•ç»“æœ
        â†“
[6. æ•°æ®å›æµæ¨¡å—]
   â”œâ”€ å®šæ—¶æŠ“å–äº’åŠ¨æ•°æ®
   â”œâ”€ è®¡ç®—çœŸå®è¯„åˆ†
   â””â”€ æ›´æ–°é¢„æµ‹è¯¯å·®
```

---

## 3. å¼€å‘ç¯å¢ƒæ­å»º

### 3.1 æœåŠ¡å™¨è¦æ±‚

| é¡¹ç›® | æœ€ä½é…ç½® | æ¨èé…ç½® |
|------|----------|----------|
| CPU | 2æ ¸ | 4æ ¸ |
| å†…å­˜ | 4GB | 8GB |
| å­˜å‚¨ | 50GB SSD | 100GB SSD |
| ç³»ç»Ÿ | Ubuntu 22.04 LTS | Ubuntu 22.04 LTS |
| ç½‘ç»œ | å…¬ç½‘IP | å…¬ç½‘IP + åŸŸå |

### 3.2 ç¯å¢ƒåˆå§‹åŒ–

```bash
#!/bin/bash
# scripts/setup.sh

# 1. ç³»ç»Ÿæ›´æ–°
sudo apt update && sudo apt upgrade -y

# 2. å®‰è£…Docker
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# 3. å®‰è£…Docker Compose
sudo apt install docker-compose -y

# 4. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p ~/xhs_publisher/{n8n_data,backups}

# 5. å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿ï¼ˆä¸è¦ç›´æ¥åœ¨è„šæœ¬ä¸­å†™å…¥æ•æ„Ÿä¿¡æ¯ï¼‰
cp .env.example .env
echo "è¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥çœŸå®çš„ API å¯†é’¥"
```

### 3.3 Docker Compose é…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ==================== çˆ†æ¬¾é‡‡é›†å¹³å° ====================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: xhs-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@db:5432/xhs_platform
      - REDIS_URL=redis://redis:6379
      - NEXT_PUBLIC_API_URL=${WEB_PLATFORM_URL}
    depends_on:
      - db
      - redis
    networks:
      - xhs-network
    deploy:
      resources:
        limits:
          memory: 2G  # Puppeteer éœ€è¦è¾ƒå¤šå†…å­˜

  # ==================== PostgreSQL æ•°æ®åº“ ====================
  db:
    image: postgres:15-alpine
    container_name: xhs-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=xhs_platform
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - xhs-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== Redis ç¼“å­˜/é˜Ÿåˆ— ====================
  redis:
    image: redis:7-alpine
    container_name: xhs-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - xhs-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== N8N å·¥ä½œæµå¼•æ“ ====================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://${N8N_HOST}/
      - GENERIC_TIMEZONE=Asia/Shanghai
      - TZ=Asia/Shanghai
      # çˆ†æ¬¾é‡‡é›†å¹³å° URL (ä¾› N8N è°ƒç”¨)
      - WEB_PLATFORM_URL=${WEB_PLATFORM_URL}
    volumes:
      - ./n8n_data:/home/node/.n8n
      - ./backups:/backups
    networks:
      - xhs-network

  # ==================== Nginx åå‘ä»£ç† ====================
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/nginx/ssl:/etc/nginx/ssl
      - ./docker/nginx/certbot:/var/www/certbot
    depends_on:
      - web
      - n8n
    networks:
      - xhs-network

volumes:
  postgres_data:
  redis_data:

networks:
  xhs-network:
    driver: bridge
```

#### å¼€å‘ç¯å¢ƒé…ç½®

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  db:
    image: postgres:15-alpine
    container_name: xhs-db-dev
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dev_password
      - POSTGRES_DB=xhs_platform_dev
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: xhs-redis-dev
    ports:
      - "6379:6379"

volumes:
  postgres_data_dev:
```

#### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.example
# ===== é€šç”¨é…ç½® =====
NODE_ENV=production
TZ=Asia/Shanghai

# ===== æ•°æ®åº“é…ç½® =====
DB_PASSWORD=your_secure_password
DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@db:5432/xhs_platform

# ===== Redis é…ç½® =====
REDIS_URL=redis://redis:6379

# ===== çˆ†æ¬¾é‡‡é›†å¹³å°é…ç½® =====
WEB_PLATFORM_URL=https://your-domain.com

# ===== N8N é…ç½® =====
N8N_HOST=n8n.your-domain.com

# ===== API å¯†é’¥ (è¯·å‹¿æäº¤çœŸå®å€¼) =====
CLAUDE_API_KEY=sk-xxx-placeholder
GEMINI_API_KEY=xxx-placeholder
LARK_APP_ID=cli_xxx
LARK_APP_SECRET=xxx-placeholder
TELEGRAM_BOT_TOKEN=xxx-placeholder
```

### 3.4 Nginxé…ç½®

```nginx
# nginx/conf.d/n8n.conf
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    location / {
        proxy_pass http://n8n:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
```

### 3.5 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f n8n

# åœæ­¢æœåŠ¡
docker-compose down
```

---

## 4. çˆ†æ¬¾é‡‡é›†å¹³å°å¼€å‘æŒ‡å—

æœ¬ç« è¯¦ç»†è¯´æ˜çˆ†æ¬¾é‡‡é›†å¹³å° (Web) çš„å¼€å‘è§„èŒƒå’Œå®ç°ç»†èŠ‚ã€‚

### 4.1 å¹³å°åŠŸèƒ½æ¨¡å—

| ä¼˜å…ˆçº§ | æ¨¡å— | è¯´æ˜ |
|--------|------|------|
| **P0** | å…³é”®è¯æœç´¢é‡‡é›† | æ ¸å¿ƒåŠŸèƒ½ï¼Œæ ¹æ®å…³é”®è¯æœç´¢çˆ†æ¬¾ |
| **P0** | å†…å®¹åº“ç®¡ç† | æ ¸å¿ƒåŠŸèƒ½ï¼Œå±•ç¤ºå’Œç®¡ç†é‡‡é›†æ•°æ® |
| **P0** | é‡‡é›†ä»»åŠ¡ç®¡ç† | æ ¸å¿ƒåŠŸèƒ½ï¼Œç®¡ç†å®šæ—¶å’Œæ‰‹åŠ¨ä»»åŠ¡ |
| **P1** | ä½œè€…ç›‘æ§é‡‡é›† | é‡è¦åŠŸèƒ½ï¼Œè¿½è¸ªç‰¹å®šä½œè€… |
| **P1** | æ•°æ®åˆ†æä»ªè¡¨ç›˜ | é‡è¦åŠŸèƒ½ï¼Œè¶‹åŠ¿å’Œç»Ÿè®¡åˆ†æ |
| **P2** | AI é€‰é¢˜æ¨è | ä¼˜åŒ–åŠŸèƒ½ï¼Œæ™ºèƒ½æ¨èé€‰é¢˜ |
| **P2** | æ”¶è—å¤¹ç®¡ç† | ä¼˜åŒ–åŠŸèƒ½ï¼Œæ•´ç†å†…å®¹åº“ |

### 4.2 æ¨¡å—ä¸€ï¼šPuppeteer é‡‡é›†å¼•æ“

#### 4.2.1 åŠŸèƒ½è¯´æ˜

ä½¿ç”¨ Puppeteer æ— å¤´æµè§ˆå™¨æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸ºï¼Œé‡‡é›†å°çº¢ä¹¦æœç´¢ç»“æœå’Œä½œè€…ä¸»é¡µæ•°æ®ã€‚

#### 4.2.2 æ ¸å¿ƒç±»è®¾è®¡

```typescript
// apps/web/src/lib/crawler/xhs-crawler.ts

import puppeteer, { Browser, Page } from 'puppeteer';

export interface SearchOptions {
  keyword: string;
  sortBy?: 'general' | 'latest' | 'hot';  // ç»¼åˆ/æœ€æ–°/æœ€çƒ­
  noteType?: 'all' | 'video' | 'image';   // å…¨éƒ¨/è§†é¢‘/å›¾æ–‡
  limit?: number;
  minLikes?: number;                       // æœ€ä½ç‚¹èµæ•°ç­›é€‰
}

export interface NoteItem {
  noteId: string;
  title: string;
  cover: string;
  author: string;
  authorId: string;
  likes: number;
  collects: number;
  comments: number;
  noteUrl: string;
  noteType: 'image' | 'video';
  tags: string[];
}

export class XhsCrawler {
  private browser: Browser | null = null;
  private cookieManager: CookieManager;

  constructor(cookieManager: CookieManager) {
    this.cookieManager = cookieManager;
  }

  /**
   * åˆå§‹åŒ–æµè§ˆå™¨å®ä¾‹
   */
  async init(): Promise<void> {
    this.browser = await puppeteer.launch({
      headless: 'new',
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu'
      ]
    });
  }

  /**
   * å…³é”®è¯æœç´¢é‡‡é›†
   */
  async searchNotes(options: SearchOptions): Promise<NoteItem[]> {
    const { keyword, sortBy = 'hot', limit = 20, minLikes = 0 } = options;
    const page = await this.createPage();

    try {
      // æ„å»ºæœç´¢ URL
      const searchUrl = this.buildSearchUrl(keyword, sortBy);
      await page.goto(searchUrl, { waitUntil: 'networkidle2', timeout: 30000 });

      // ç­‰å¾…æœç´¢ç»“æœåŠ è½½
      await page.waitForSelector('[data-v-a264b01a].note-item, .note-item', {
        timeout: 10000
      });

      // æ»šåŠ¨åŠ è½½æ›´å¤šå†…å®¹
      await this.autoScroll(page, limit);

      // è§£ææœç´¢ç»“æœ
      let notes = await this.parseSearchResults(page);

      // ç­›é€‰ç¬¦åˆç‚¹èµæ•°è¦æ±‚çš„ç¬”è®°
      if (minLikes > 0) {
        notes = notes.filter(n => n.likes >= minLikes);
      }

      return notes.slice(0, limit);
    } finally {
      await page.close();
    }
  }

  /**
   * è·å–ç¬”è®°è¯¦æƒ…
   */
  async getNoteDetail(noteUrl: string): Promise<NoteDetail | null> {
    const page = await this.createPage();

    try {
      await page.goto(noteUrl, { waitUntil: 'networkidle2', timeout: 30000 });
      await page.waitForSelector('.note-content, .note-detail', { timeout: 10000 });

      return await page.evaluate(() => {
        return {
          title: document.querySelector('.title')?.textContent?.trim() || '',
          content: document.querySelector('.desc, .content')?.textContent?.trim() || '',
          likes: parseInt(document.querySelector('.like-wrapper .count')?.textContent || '0'),
          collects: parseInt(document.querySelector('.collect-wrapper .count')?.textContent || '0'),
          comments: parseInt(document.querySelector('.chat-wrapper .count')?.textContent || '0'),
          tags: Array.from(document.querySelectorAll('.tag, #hash-tag')).map(t => t.textContent?.trim() || ''),
          publishTime: document.querySelector('.date, .publish-date')?.textContent?.trim()
        };
      });
    } catch (error) {
      console.error('è·å–ç¬”è®°è¯¦æƒ…å¤±è´¥:', error);
      return null;
    } finally {
      await page.close();
    }
  }

  /**
   * é‡‡é›†ä½œè€…ä¸»é¡µç¬”è®°
   */
  async crawlAuthorNotes(authorId: string, limit = 20): Promise<NoteItem[]> {
    const page = await this.createPage();

    try {
      const profileUrl = `https://www.xiaohongshu.com/user/profile/${authorId}`;
      await page.goto(profileUrl, { waitUntil: 'networkidle2' });

      await page.waitForSelector('#userPostedFeeds', { timeout: 10000 });
      await this.autoScroll(page, limit);

      return await this.parseAuthorNotes(page, authorId);
    } finally {
      await page.close();
    }
  }

  /**
   * åˆ›å»ºå¸¦ Cookie çš„é¡µé¢
   */
  private async createPage(): Promise<Page> {
    if (!this.browser) {
      throw new Error('Browser not initialized');
    }

    const page = await this.browser.newPage();

    // è®¾ç½® User-Agent
    await page.setUserAgent(
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    );

    // è®¾ç½® Cookie
    const cookies = await this.cookieManager.getActiveCookies();
    if (cookies.length > 0) {
      await page.setCookie(...cookies);
    }

    // è®¾ç½®è§†å£
    await page.setViewport({ width: 1920, height: 1080 });

    return page;
  }

  /**
   * è‡ªåŠ¨æ»šåŠ¨åŠ è½½æ›´å¤š
   */
  private async autoScroll(page: Page, targetCount: number): Promise<void> {
    let previousCount = 0;
    let sameCountTimes = 0;

    while (sameCountTimes < 3) {
      const currentCount = await page.evaluate(() =>
        document.querySelectorAll('.note-item').length
      );

      if (currentCount >= targetCount) break;

      if (currentCount === previousCount) {
        sameCountTimes++;
      } else {
        sameCountTimes = 0;
      }

      previousCount = currentCount;

      await page.evaluate(() => window.scrollBy(0, 800));
      await this.delay(1000 + Math.random() * 1000); // éšæœºå»¶è¿Ÿ
    }
  }

  private buildSearchUrl(keyword: string, sortBy: string): string {
    const params = new URLSearchParams({
      keyword: keyword,
      source: 'web_search_result_notes',
      search_id: this.generateSearchId(),
      sort: sortBy === 'latest' ? 'time_descending' : 'general'
    });
    return `https://www.xiaohongshu.com/search_result?${params.toString()}`;
  }

  private generateSearchId(): string {
    return Math.random().toString(36).substring(2, 15);
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async close(): Promise<void> {
    await this.browser?.close();
  }
}
```

#### 4.2.3 Cookie ç®¡ç†å™¨

```typescript
// apps/web/src/lib/crawler/cookie-manager.ts

import { prisma } from '@/lib/db';
import { encrypt, decrypt } from '@/lib/utils/crypto';

export class CookieManager {
  /**
   * è·å–å¯ç”¨çš„ Cookieï¼ˆè½®æ¢æœºåˆ¶ï¼‰
   */
  async getActiveCookies(): Promise<any[]> {
    const account = await prisma.xhsAccount.findFirst({
      where: { isActive: true },
      orderBy: { lastUsedAt: 'asc' } // æœ€ä¹…æœªä½¿ç”¨çš„ä¼˜å…ˆ
    });

    if (!account) {
      throw new Error('No active XHS account available');
    }

    // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
    await prisma.xhsAccount.update({
      where: { id: account.id },
      data: { lastUsedAt: new Date() }
    });

    // è§£å¯†å¹¶è§£æ Cookie
    const decrypted = decrypt(account.cookies);
    return JSON.parse(decrypted);
  }

  /**
   * æ·»åŠ æ–°è´¦å·
   */
  async addAccount(name: string, cookies: string): Promise<void> {
    const encrypted = encrypt(cookies);
    await prisma.xhsAccount.create({
      data: {
        name,
        cookies: encrypted,
        isActive: true
      }
    });
  }

  /**
   * æ ‡è®°è´¦å·å¤±æ•ˆ
   */
  async markInactive(accountId: string): Promise<void> {
    await prisma.xhsAccount.update({
      where: { id: accountId },
      data: { isActive: false }
    });
  }
}
```

#### 4.2.4 é”™è¯¯å¤„ç†ä¸é‡è¯•

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|----------|----------|
| Cookie è¿‡æœŸ | åˆ‡æ¢è´¦å·ï¼Œé€šçŸ¥ç®¡ç†å‘˜æ›´æ–° Cookie |
| é¡µé¢åŠ è½½è¶…æ—¶ | é‡è¯• 3 æ¬¡ï¼Œé—´éš”é€’å¢ |
| è¢«é£æ§/éªŒè¯ç  | æš‚åœè¯¥è´¦å· 2 å°æ—¶ï¼Œåˆ‡æ¢è´¦å· |
| ç½‘ç»œå¼‚å¸¸ | é‡è¯• 3 æ¬¡ï¼Œè®°å½•é”™è¯¯æ—¥å¿— |

### 4.3 æ¨¡å—äºŒï¼šä»»åŠ¡é˜Ÿåˆ— (BullMQ)

#### 4.3.1 é˜Ÿåˆ—è®¾è®¡

```typescript
// apps/web/src/lib/queue/crawl-queue.ts

import { Queue, Worker, Job } from 'bullmq';
import { redis } from '@/lib/redis';
import { XhsCrawler } from '@/lib/crawler/xhs-crawler';
import { prisma } from '@/lib/db';

// å®šä¹‰ä»»åŠ¡ç±»å‹
export type CrawlJobType =
  | 'search_keyword'    // å…³é”®è¯æœç´¢
  | 'crawl_author'      // ä½œè€…é‡‡é›†
  | 'fetch_detail'      // è·å–è¯¦æƒ…
  | 'scheduled_crawl';  // å®šæ—¶é‡‡é›†

export interface CrawlJobData {
  type: CrawlJobType;
  params: {
    keyword?: string;
    authorId?: string;
    noteUrl?: string;
    keywordId?: string;
    minLikes?: number;
    limit?: number;
  };
}

// åˆ›å»ºé˜Ÿåˆ—
export const crawlQueue = new Queue<CrawlJobData>('xhs-crawl', {
  connection: redis,
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 5000
    },
    removeOnComplete: 100,
    removeOnFail: 50
  }
});

// åˆ›å»º Worker
export const crawlWorker = new Worker<CrawlJobData>(
  'xhs-crawl',
  async (job: Job<CrawlJobData>) => {
    const { type, params } = job.data;
    const crawler = new XhsCrawler(new CookieManager());

    try {
      await crawler.init();

      // æ›´æ–°ä»»åŠ¡çŠ¶æ€
      await updateTaskStatus(job.id!, 'RUNNING');

      let result;
      switch (type) {
        case 'search_keyword':
          result = await handleSearchKeyword(crawler, params, job);
          break;
        case 'crawl_author':
          result = await handleCrawlAuthor(crawler, params, job);
          break;
        case 'fetch_detail':
          result = await handleFetchDetail(crawler, params);
          break;
        case 'scheduled_crawl':
          result = await handleScheduledCrawl(crawler, job);
          break;
      }

      await updateTaskStatus(job.id!, 'COMPLETED', result);
      return result;

    } catch (error) {
      await updateTaskStatus(job.id!, 'FAILED', null, error.message);
      throw error;
    } finally {
      await crawler.close();
    }
  },
  {
    connection: redis,
    concurrency: 2, // å¹¶å‘æ•°é™åˆ¶ï¼Œé¿å…è¢«é£æ§
    limiter: {
      max: 10,
      duration: 60000 // æ¯åˆ†é’Ÿæœ€å¤š 10 ä¸ªä»»åŠ¡
    }
  }
);

// å¤„ç†å…³é”®è¯æœç´¢
async function handleSearchKeyword(
  crawler: XhsCrawler,
  params: CrawlJobData['params'],
  job: Job
) {
  const notes = await crawler.searchNotes({
    keyword: params.keyword!,
    minLikes: params.minLikes || 500,
    limit: params.limit || 50
  });

  // æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
  const saved = await saveNotes(notes, params.keyword!, 'SEARCH');

  // æ›´æ–°å…³é”®è¯ç»Ÿè®¡
  if (params.keywordId) {
    await prisma.keyword.update({
      where: { id: params.keywordId },
      data: {
        lastCrawledAt: new Date(),
        totalNotes: { increment: saved.length }
      }
    });
  }

  return { notesCount: saved.length, notes: saved };
}

// å®šæ—¶ä»»åŠ¡å…¥å£
export async function scheduleKeywordCrawl(): Promise<void> {
  const keywords = await prisma.keyword.findMany({
    where: { isActive: true }
  });

  for (const kw of keywords) {
    await crawlQueue.add(
      'scheduled_crawl',
      {
        type: 'search_keyword',
        params: {
          keyword: kw.keyword,
          keywordId: kw.id,
          minLikes: kw.minLikes,
          limit: 50
        }
      },
      {
        jobId: `scheduled_${kw.id}_${Date.now()}`
      }
    );
  }
}
```

#### 4.3.2 å®šæ—¶ä»»åŠ¡é…ç½®

```typescript
// apps/web/src/lib/queue/scheduler.ts

import { scheduleKeywordCrawl } from './crawl-queue';
import cron from 'node-cron';

// æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡å…³é”®è¯é‡‡é›†
cron.schedule('0 */6 * * *', async () => {
  console.log('Starting scheduled keyword crawl...');
  await scheduleKeywordCrawl();
});

// æ¯å¤©å‡Œæ™¨æ¸…ç†è¿‡æœŸæ•°æ®
cron.schedule('0 2 * * *', async () => {
  console.log('Starting data cleanup...');
  await cleanupOldData();
});
```

### 4.4 æ¨¡å—ä¸‰ï¼šå†…å®¹åº“ç®¡ç†

#### 4.4.1 ç¬”è®°åˆ—è¡¨é¡µ

```typescript
// apps/web/src/app/(dashboard)/library/page.tsx

import { Suspense } from 'react';
import { NoteList } from '@/components/notes/note-list';
import { NoteFilters } from '@/components/notes/note-filters';
import { prisma } from '@/lib/db';

interface LibraryPageProps {
  searchParams: {
    keyword?: string;
    minLikes?: string;
    sortBy?: string;
    page?: string;
  };
}

export default async function LibraryPage({ searchParams }: LibraryPageProps) {
  const page = parseInt(searchParams.page || '1');
  const pageSize = 20;

  const where = {
    ...(searchParams.keyword && {
      OR: [
        { title: { contains: searchParams.keyword } },
        { keyword: { contains: searchParams.keyword } }
      ]
    }),
    ...(searchParams.minLikes && {
      likes: { gte: parseInt(searchParams.minLikes) }
    })
  };

  const [notes, total] = await Promise.all([
    prisma.note.findMany({
      where,
      orderBy: getOrderBy(searchParams.sortBy),
      skip: (page - 1) * pageSize,
      take: pageSize
    }),
    prisma.note.count({ where })
  ]);

  return (
    <div className="container py-6">
      <h1 className="text-2xl font-bold mb-6">å†…å®¹åº“</h1>

      <NoteFilters />

      <Suspense fallback={<div>Loading...</div>}>
        <NoteList notes={notes} />
      </Suspense>

      <Pagination total={total} pageSize={pageSize} current={page} />
    </div>
  );
}
```

#### 4.4.2 ç¬”è®°å¡ç‰‡ç»„ä»¶

```typescript
// apps/web/src/components/notes/note-card.tsx

'use client';

import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Heart, Bookmark, MessageCircle, Star, ExternalLink } from 'lucide-react';
import { formatNumber } from '@/lib/utils/format';
import type { Note } from '@prisma/client';

interface NoteCardProps {
  note: Note;
  onStar?: (id: string) => void;
  onUseForTopic?: (note: Note) => void;
}

export function NoteCard({ note, onStar, onUseForTopic }: NoteCardProps) {
  return (
    <Card className="overflow-hidden hover:shadow-lg transition-shadow">
      {/* å°é¢å›¾ */}
      <div className="relative aspect-[3/4] overflow-hidden">
        <img
          src={note.cover || '/placeholder.png'}
          alt={note.title}
          className="object-cover w-full h-full"
        />
        {note.noteType === 'VIDEO' && (
          <Badge className="absolute top-2 right-2">è§†é¢‘</Badge>
        )}
        {note.isStarred && (
          <Star className="absolute top-2 left-2 text-yellow-400 fill-yellow-400" />
        )}
      </div>

      <CardContent className="p-4">
        {/* æ ‡é¢˜ */}
        <h3 className="font-medium line-clamp-2 mb-2">{note.title}</h3>

        {/* ä½œè€… */}
        <p className="text-sm text-muted-foreground mb-2">
          @{note.authorName}
        </p>

        {/* äº’åŠ¨æ•°æ® */}
        <div className="flex items-center gap-4 text-sm text-muted-foreground">
          <span className="flex items-center gap-1">
            <Heart className="w-4 h-4" />
            {formatNumber(note.likes)}
          </span>
          <span className="flex items-center gap-1">
            <Bookmark className="w-4 h-4" />
            {formatNumber(note.collects)}
          </span>
          <span className="flex items-center gap-1">
            <MessageCircle className="w-4 h-4" />
            {formatNumber(note.comments)}
          </span>
        </div>

        {/* æ ‡ç­¾ */}
        {note.tags.length > 0 && (
          <div className="flex flex-wrap gap-1 mt-2">
            {note.tags.slice(0, 3).map(tag => (
              <Badge key={tag} variant="secondary" className="text-xs">
                {tag}
              </Badge>
            ))}
          </div>
        )}
      </CardContent>

      <CardFooter className="p-4 pt-0 flex gap-2">
        <Button
          variant="outline"
          size="sm"
          onClick={() => onStar?.(note.id)}
        >
          <Star className="w-4 h-4 mr-1" />
          æ”¶è—
        </Button>
        <Button
          variant="default"
          size="sm"
          onClick={() => onUseForTopic?.(note)}
        >
          ç”¨äºé€‰é¢˜
        </Button>
        <Button
          variant="ghost"
          size="sm"
          asChild
        >
          <a href={note.noteUrl} target="_blank" rel="noopener noreferrer">
            <ExternalLink className="w-4 h-4" />
          </a>
        </Button>
      </CardFooter>
    </Card>
  );
}
```

### 4.5 æ¨¡å—å››ï¼šæ•°æ®åˆ†æ

#### 4.5.1 åˆ†æç»´åº¦

| ç»´åº¦ | æŒ‡æ ‡ | ç”¨é€” |
|------|------|------|
| é‡‡é›†è¶‹åŠ¿ | æ¯æ—¥/å‘¨é‡‡é›†æ•°é‡ | ç›‘æ§é‡‡é›†æ•ˆç‡ |
| çˆ†æ¬¾åˆ†å¸ƒ | ç‚¹èµæ•°åˆ†å¸ƒå›¾ | äº†è§£çˆ†æ¬¾æ ‡å‡† |
| å…³é”®è¯çƒ­åº¦ | å„å…³é”®è¯é‡‡é›†æ•°é‡ | ä¼˜åŒ–ç›‘æ§ç­–ç•¥ |
| ä½œè€…æ’å | é«˜é¢‘å‡ºç°çš„ä½œè€… | å‘ç°ä¼˜è´¨åšä¸» |
| å†…å®¹ç±»å‹ | å›¾æ–‡ vs è§†é¢‘å æ¯” | æŒ‡å¯¼å†…å®¹å½¢å¼ |
| å‘å¸ƒæ—¶é—´ | çˆ†æ¬¾å‘å¸ƒæ—¶é—´åˆ†å¸ƒ | ä¼˜åŒ–å‘å¸ƒç­–ç•¥ |

#### 4.5.2 ä»ªè¡¨ç›˜ç»„ä»¶

```typescript
// apps/web/src/app/(dashboard)/analytics/page.tsx

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { TrendChart } from '@/components/charts/trend-chart';
import { DistributionChart } from '@/components/charts/distribution-chart';
import { getAnalyticsData } from '@/lib/analytics';

export default async function AnalyticsPage() {
  const data = await getAnalyticsData();

  return (
    <div className="container py-6">
      <h1 className="text-2xl font-bold mb-6">æ•°æ®åˆ†æ</h1>

      {/* æ¦‚è§ˆå¡ç‰‡ */}
      <div className="grid grid-cols-4 gap-4 mb-6">
        <StatCard title="ä»Šæ—¥é‡‡é›†" value={data.todayCount} change={data.todayChange} />
        <StatCard title="çˆ†æ¬¾ç¬”è®°" value={data.hotCount} subtitle="likes > 1000" />
        <StatCard title="ç›‘æ§å…³é”®è¯" value={data.keywordCount} />
        <StatCard title="ç›‘æ§ä½œè€…" value={data.authorCount} />
      </div>

      {/* å›¾è¡¨ */}
      <div className="grid grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>é‡‡é›†è¶‹åŠ¿ (è¿‘7å¤©)</CardTitle>
          </CardHeader>
          <CardContent>
            <TrendChart data={data.trendData} />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>ç‚¹èµæ•°åˆ†å¸ƒ</CardTitle>
          </CardHeader>
          <CardContent>
            <DistributionChart data={data.likesDistribution} />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>çƒ­é—¨å…³é”®è¯</CardTitle>
          </CardHeader>
          <CardContent>
            <KeywordRanking data={data.keywordRanking} />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>å†…å®¹ç±»å‹åˆ†å¸ƒ</CardTitle>
          </CardHeader>
          <CardContent>
            <TypePieChart data={data.typeDistribution} />
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

### 4.6 ä¸ N8N é›†æˆ

#### 4.6.1 Webhook æ¥å£

```typescript
// apps/web/src/app/api/webhook/n8n/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/db';

// N8N è°ƒç”¨æ­¤æ¥å£è·å–çˆ†æ¬¾æ•°æ®
export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const minLikes = parseInt(searchParams.get('minLikes') || '1000');
  const limit = parseInt(searchParams.get('limit') || '10');
  const keyword = searchParams.get('keyword');
  const days = parseInt(searchParams.get('days') || '7');

  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);

  const notes = await prisma.note.findMany({
    where: {
      likes: { gte: minLikes },
      isUsed: false,
      crawledAt: { gte: startDate },
      ...(keyword && { keyword: { contains: keyword } })
    },
    orderBy: { likes: 'desc' },
    take: limit,
    select: {
      id: true,
      noteId: true,
      title: true,
      content: true,
      likes: true,
      collects: true,
      tags: true,
      keyword: true,
      noteUrl: true
    }
  });

  return NextResponse.json({
    success: true,
    data: notes,
    total: notes.length
  });
}

// N8N è°ƒç”¨æ­¤æ¥å£æ ‡è®°ç¬”è®°å·²ä½¿ç”¨
export async function POST(request: NextRequest) {
  const body = await request.json();
  const { noteIds, action } = body;

  if (action === 'mark_used') {
    await prisma.note.updateMany({
      where: { id: { in: noteIds } },
      data: { isUsed: true, usedAt: new Date() }
    });
  }

  return NextResponse.json({ success: true });
}
```

#### 4.6.2 N8N å·¥ä½œæµé›†æˆç¤ºä¾‹

```json
{
  "name": "hot_content_collector_v1",
  "nodes": [
    {
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "parameters": {
        "rule": { "interval": [{ "field": "hours", "hoursInterval": 6 }] }
      }
    },
    {
      "name": "Fetch Hot Notes",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "={{$env.WEB_PLATFORM_URL}}/api/webhook/n8n",
        "method": "GET",
        "qs": {
          "minLikes": 1000,
          "limit": 10,
          "days": 7
        }
      }
    },
    {
      "name": "Process Notes",
      "type": "n8n-nodes-base.code",
      "parameters": {
        "jsCode": "// è½¬æ¢ä¸ºé€‰é¢˜å‚è€ƒæ ¼å¼\nconst notes = $input.first().json.data;\nreturn notes.map(note => ({\n  json: {\n    reference_title: note.title,\n    reference_tags: note.tags,\n    reference_likes: note.likes,\n    source: 'hot_collection'\n  }\n}));"
      }
    }
  ]
}
```

---

## 5. N8Nå·¥ä½œæµæ¨¡å—å¼€å‘æŒ‡å—

æœ¬ç« è¯¦ç»†è¯´æ˜ N8N å·¥ä½œæµçš„å¼€å‘è§„èŒƒå’Œå®ç°ç»†èŠ‚ã€‚

### 5.1 æ¨¡å—ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ¨¡å— | è¯´æ˜ |
|--------|------|------|
| **P0** | æ™ºèƒ½é€‰é¢˜ | æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»é¦–å…ˆå®ç° |
| **P0** | å†…å®¹åˆ›ä½œ+AIå®¡æ ¸ | æ ¸å¿ƒåŠŸèƒ½ |
| **P0** | æ•°æ®å­˜å‚¨(é£ä¹¦) | æ ¸å¿ƒåŠŸèƒ½ |
| **P0** | é€šçŸ¥(Telegram) | æ ¸å¿ƒåŠŸèƒ½ |
| **P1** | å›¾ç‰‡ç”Ÿæˆ | é‡è¦åŠŸèƒ½ |
| **P1** | çƒ­ç‚¹æŠ“å– | é‡è¦åŠŸèƒ½ |
| **P1** | åŠè‡ªåŠ¨å‘å¸ƒ(MCP) | é‡è¦åŠŸèƒ½ |
| **P2** | æ™ºèƒ½å®šæ—¶ | ä¼˜åŒ–åŠŸèƒ½ |
| **P2** | äº’åŠ¨æ•°æ®å›æµ | ä¼˜åŒ–åŠŸèƒ½ |
| **P2** | AIè¯„åˆ†é—­ç¯ | ä¼˜åŒ–åŠŸèƒ½ |

### 5.2 æ¨¡å—ä¸€ï¼šæ™ºèƒ½é€‰é¢˜

#### 4.2.1 åŠŸèƒ½è¯´æ˜

åŸºäºå…³é”®è¯+çƒ­ç‚¹è¶‹åŠ¿ç”Ÿæˆ3-5ä¸ªå€™é€‰é€‰é¢˜ï¼Œ100åˆ†åˆ¶è¯„åˆ†æ’åºã€‚

#### 4.2.2 è¾“å…¥/è¾“å‡ºè§„æ ¼

**è¾“å…¥ï¼š**
```json
{
  "keyword": "AIè‡ªåŠ¨åŒ–",           // å¿…å¡«
  "target_audience": "å¼€å‘è€…",     // å¯é€‰
  "content_style": "å¹²è´§æ•™ç¨‹"      // å¯é€‰
}
```

**è¾“å‡ºï¼š**
```json
{
  "selected_topic_id": "uuid-xxx",
  "title": "æ ‡é¢˜15-30å­—",
  "core_points": ["å–ç‚¹1", "å–ç‚¹2", "å–ç‚¹3"],
  "score": 85,
  "prompt_id": "TOPIC_GEN",
  "prompt_version": "V1"
}
```

#### 4.2.3 è¯„åˆ†ä½“ç³»(100åˆ†)

| ç»´åº¦ | æƒé‡ | è¯„ä¼°è¦ç´  |
|------|------|----------|
| A.ç‚¹å‡»åŠ› | 30% | å°é¢10åˆ†+æ ‡é¢˜20åˆ† |
| B.å†…å®¹åŠ› | 25% | ç»“æ„8+å¯†åº¦9+é€»è¾‘8 |
| C.ä»·å€¼æ„Ÿ | 20% | å¹²è´§7+æƒ…ç»ª7+è§£å†³6 |
| D.äº’åŠ¨è®¾è®¡ | 10% | è¯„è®º4+æ”¶è—3+è½¬åŒ–3 |
| E.å¹³å°é€‚é… | 15% | æ ‡ç­¾5+SEO5+æ’ç‰ˆ3+åˆè§„2 |

**é€šè¿‡æ ‡å‡†ï¼š**
- 90-100ï¼šä¼˜ç§€ï¼Œç›´æ¥å‘å¸ƒ
- 80-89ï¼šè‰¯å¥½ï¼Œå¯å‘å¸ƒ
- 70-79ï¼šéœ€ä¼˜åŒ–åå‘å¸ƒ
- <70ï¼šé‡æ–°ç”Ÿæˆ

#### 4.2.4 N8NèŠ‚ç‚¹æµç¨‹

```
[Schedule Trigger] (æ¯å¤©9:00)
       â†“
[Fetch_Config] â†’ ä»é£ä¹¦è¯»å–é…ç½®
       â†“
[AI_Gateway] task=generate_topic â†’ ç”Ÿæˆ3-5é€‰é¢˜
       â†“
[Fetch_Hot_Trends] â†’ æŠ“å–çƒ­æœ
       â†“
[Match_Trends] â†’ è¯­ä¹‰åŒ¹é…(â‰¥70%ç›¸å…³åº¦)
       â†“
[AI_Gateway] task=score â†’ å¯¹æ¯ä¸ªé€‰é¢˜è¯„åˆ†
       â†“
[Select_Best] â†’ é€‰æœ€é«˜åˆ†(â‰¥80)
       â†“
[Save_To_Lark] â†’ å­˜å‚¨åˆ°é£ä¹¦
       â†“
[Send_Notification] â†’ Telegramæ¨é€
```

#### 4.2.5 Promptæ¨¡æ¿

```markdown
# config/prompts/topic_generation.md
# PROMPT_ID: TOPIC_GEN | VERSION: V1 | UPDATED: 2024-12-11

## è§’è‰²
ä½ æ˜¯ä¸€ä½èµ„æ·±å°çº¢ä¹¦å†…å®¹ç­–åˆ’å¸ˆï¼Œæ“…é•¿å‘ç°çƒ­ç‚¹è¯é¢˜å¹¶åˆ›ä½œçˆ†æ¬¾é€‰é¢˜ã€‚

## ä»»åŠ¡
åŸºäºä»¥ä¸‹å…³é”®è¯ç”Ÿæˆ3-5ä¸ªå°çº¢ä¹¦é€‰é¢˜ï¼š

**å…³é”®è¯**ï¼š{{keyword}}
**ç›®æ ‡å—ä¼—**ï¼š{{target_audience}}
**å†…å®¹é£æ ¼**ï¼š{{content_style}}

## è¾“å‡ºè¦æ±‚
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œæ¯ä¸ªé€‰é¢˜åŒ…å«ï¼š
1. title: æ ‡é¢˜(15-30å­—ï¼Œå¸¦emoji)
2. core_points: 3ä¸ªæ ¸å¿ƒå–ç‚¹
3. hook: å¼€å¤´é’©å­(è®©äººæƒ³ç‚¹è¿›æ¥)
4. target_emotion: ç›®æ ‡æƒ…ç»ª(å¥½å¥‡/ç„¦è™‘/å…±é¸£/è·å¾—æ„Ÿ)

## é€‰é¢˜æ ‡å‡†
- æ ‡é¢˜å¿…é¡»æœ‰æ•°å­—æˆ–å¯¹æ¯”
- åŒ…å«ç—›ç‚¹æˆ–è§£å†³æ–¹æ¡ˆ
- é€‚åˆå°çº¢ä¹¦ç”¨æˆ·ç¾¤ä½“
- ç¬¦åˆå¹³å°è°ƒæ€§
```

#### 4.2.6 é”™è¯¯å¤„ç†

| é”™è¯¯åœºæ™¯ | å¤„ç†æ–¹å¼ |
|----------|----------|
| Claudeé™é¢‘ | ç­‰å¾…60sé‡è¯•ï¼Œæœ€å¤š3æ¬¡ |
| çƒ­ç‚¹æŠ“å–å¤±è´¥ | è·³è¿‡çƒ­ç‚¹åŒ¹é…ï¼Œç»§ç»­æµç¨‹ |
| è¯„åˆ†å¤±è´¥ | ä½¿ç”¨é»˜è®¤è§„åˆ™fallback |
| å­˜å‚¨å¤±è´¥ | æœ¬åœ°ç¼“å­˜+å®šæ—¶é‡è¯• |

---

### 4.3 æ¨¡å—äºŒï¼šå†…å®¹åˆ›ä½œä¸AIå®¡æ ¸

#### 4.3.1 åˆ›ä½œè§„æ ¼

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| å­—æ•° | 800-1200å­— |
| é£æ ¼ | å£è¯­åŒ–+emoji |
| ç»“æ„ | å¼€å¤´hook + ä¸»ä½“3-5ç‚¹ + ç»“å°¾äº’åŠ¨ |
| æ ‡ç­¾ | 8-10ä¸ªç›¸å…³æ ‡ç­¾ |

#### 4.3.2 5æ­¥AIå®¡æ ¸æµç¨‹

| æ­¥éª¤ | æ£€æŸ¥é¡¹ | é€šè¿‡æ ‡å‡† |
|------|--------|----------|
| Step 0 | è´¦å·å®šä½æ£€æŸ¥ | åŒ¹é…åº¦â‰¥80% |
| Step 1 | ä¸‰ç§’æµ‹è¯•(æ ‡é¢˜+å°é¢) | ç‚¹å‡»åŠ›â‰¥24åˆ† |
| Step 2 | é¦–å±æµ‹è¯• | å‰ä¸¤å±ä¼ è¾¾æ ¸å¿ƒä»·å€¼ |
| Step 3 | å…¨æ–‡è´¨é‡ | å†…å®¹åŠ›â‰¥20 + ä»·å€¼æ„Ÿâ‰¥16 |
| Step 4 | äº’åŠ¨è®¾è®¡ | äº’åŠ¨åˆ†â‰¥8åˆ† |
| Step 5 | å¹³å°åˆè§„ | é€‚é…â‰¥12 + æ•æ„Ÿè¯é€šè¿‡ |

#### 4.3.3 å®¡æ ¸ç»“æœå¤„ç†

```
è¯„åˆ†ç»“æœ â†’ [åˆ†æ”¯åˆ¤æ–­]
              â”œâ”€ score â‰¥ 80 â†’ [å‘å¸ƒé˜Ÿåˆ—]
              â”œâ”€ 70 â‰¤ score < 80 â†’ [ä¼˜åŒ–å»ºè®®] â†’ [äººå·¥å†³å®š]
              â””â”€ score < 70 â†’ [é‡æ–°ç”Ÿæˆ]
```

#### 4.3.4 Promptæ¨¡æ¿

```markdown
# config/prompts/content_creation.md
# PROMPT_ID: CONTENT_GEN | VERSION: V1 | UPDATED: 2024-12-11

## è§’è‰²
ä½ æ˜¯ä¸€ä½å°çº¢ä¹¦çˆ†æ¬¾å†…å®¹åˆ›ä½œè€…ï¼Œé£æ ¼äº²åˆ‡è‡ªç„¶ï¼Œå–„äºç”¨æ•…äº‹å’Œæ¡ˆä¾‹æ‰“åŠ¨è¯»è€…ã€‚

## ä»»åŠ¡
åŸºäºä»¥ä¸‹é€‰é¢˜åˆ›ä½œå°çº¢ä¹¦æ–‡ç« ï¼š

**æ ‡é¢˜**ï¼š{{title}}
**æ ¸å¿ƒå–ç‚¹**ï¼š{{core_points}}
**ç›®æ ‡å—ä¼—**ï¼š{{target_audience}}

## å†…å®¹ç»“æ„
1. å¼€å¤´(50-100å­—)ï¼šç”¨ç—›ç‚¹/é—®é¢˜/æ•…äº‹å¼•å…¥
2. ä¸»ä½“(600-900å­—)ï¼š3-5ä¸ªè¦ç‚¹ï¼Œæ¯ç‚¹é…æ¡ˆä¾‹
3. ç»“å°¾(50-100å­—)ï¼šæ€»ç»“+äº’åŠ¨å¼•å¯¼

## é£æ ¼è¦æ±‚
- å£è¯­åŒ–è¡¨è¾¾ï¼Œåƒæœ‹å‹èŠå¤©
- é€‚å½“ä½¿ç”¨emoji(5-10ä¸ª)
- æ®µè½çŸ­å°ï¼Œ3-5è¡Œæ¢æ®µ
- é‡ç‚¹å†…å®¹ç”¨ã€ã€‘æ ‡æ³¨

## è¾“å‡ºæ ¼å¼
```json
{
  "content": "æ­£æ–‡å†…å®¹",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2", ...],
  "summary": "ä¸€å¥è¯æ€»ç»“"
}
```
```

---

### 4.4 æ¨¡å—ä¸‰ï¼šå›¾ç‰‡ç”Ÿæˆ

#### 4.4.1 æŠ€æœ¯æ–¹æ¡ˆ

```
[å†…å®¹æ–‡æœ¬] â†’ [Claudeç”Ÿæˆæè¿°Prompt] â†’ [Gemini APIç”Ÿæˆå›¾ç‰‡] â†’ [3:4ç«–å›¾]
```

#### 4.4.2 å›¾ç‰‡è§„æ ¼

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| æ¯”ä¾‹ | 3:4 (ç«–å›¾) |
| åˆ†è¾¨ç‡ | 1080 x 1440 px |
| é£æ ¼ | ä¸å†…å®¹è°ƒæ€§ä¸€è‡´ |
| æ•°é‡ | å°é¢1å¼  + å†…å®¹å›¾2-5å¼  |

#### 4.4.3 Promptæ¨¡æ¿

```markdown
# å›¾ç‰‡æè¿°Promptç”Ÿæˆ
# PROMPT_ID: IMAGE_DESC | VERSION: V1 | UPDATED: 2024-12-11

åŸºäºä»¥ä¸‹å†…å®¹ç”Ÿæˆå›¾ç‰‡æè¿°ï¼š
**æ ‡é¢˜**ï¼š{{title}}
**ä¸»é¢˜**ï¼š{{topic}}

è¾“å‡ºè¦æ±‚ï¼š
1. ç®€æ´çš„è‹±æ–‡æè¿°
2. åŒ…å«ä¸»ä½“ã€åœºæ™¯ã€é£æ ¼
3. é€‚åˆå°çº¢ä¹¦å®¡ç¾
4. é¿å…æ–‡å­—/äººè„¸

ç¤ºä¾‹è¾“å‡ºï¼š
"A minimalist workspace with laptop showing AI interface, soft lighting, modern aesthetic, 3:4 vertical composition"
```

---

### 4.5 æ¨¡å—å››ï¼šå‘å¸ƒä¸æ™ºèƒ½å®šæ—¶

#### 4.5.1 å‘å¸ƒæ–¹å¼

**åŠè‡ªåŠ¨æµç¨‹ï¼š**
```
AIç”Ÿæˆ â†’ AIå®¡æ ¸ â†’ äººå·¥ç¡®è®¤ â†’ MCPå‘å¸ƒ
```

#### 4.5.2 æ™ºèƒ½å®šæ—¶ç­–ç•¥

**é»˜è®¤å‘å¸ƒæ—¶æ®µï¼š**

| æ—¶æ®µ | å·¥ä½œæ—¥ | å‘¨æœ« |
|------|--------|------|
| æ—©é«˜å³° | 7:00-9:00 | 10:00-11:00 |
| åˆé—´ | 12:00-13:00 | 15:00-17:00 |
| æ™šé«˜å³° | 19:00-22:00 | 20:00-22:00 |

**AIä¼˜åŒ–é€»è¾‘ï¼š**
1. åˆæœŸï¼šä½¿ç”¨é»˜è®¤æ—¶æ®µ
2. 30å¤©åï¼šåˆ†æé«˜è¡¨ç°æ—¶æ®µ(Top 20%)
3. æ¯å‘¨ï¼šåŠ¨æ€è°ƒæ•´å»ºè®®æ—¶é—´

#### 4.5.3 é™é¢‘ç­–ç•¥

```javascript
// å‘å¸ƒå‰æ£€æŸ¥
function canPublish(accountId) {
  const account = getAccount(accountId);

  // 1. æ£€æŸ¥è´¦å·çŠ¶æ€
  if (account.status !== 'ACTIVE') return false;

  // 2. æ£€æŸ¥ä»Šæ—¥å‘å¸ƒæ•°(æœ€å¤š3ç¯‡/å¤©)
  if (account.publish_count_today >= 3) return false;

  // 3. æ£€æŸ¥å‘å¸ƒé—´éš”(æœ€å°4å°æ—¶)
  const lastPublish = account.last_publish_at;
  if (Date.now() - lastPublish < 4 * 3600 * 1000) return false;

  return true;
}
```

---

### 4.6 æ¨¡å—äº”ï¼šæ•°æ®è®°å½•ä¸åˆ†æ

#### 4.6.1 æ•°æ®ç±»å‹

| ç±»å‹ | åŒ…å«å­—æ®µ |
|------|----------|
| å†…å®¹æ•°æ® | æ ‡é¢˜ã€æ­£æ–‡ã€æ ‡ç­¾ã€å›¾ç‰‡ |
| æµç¨‹æ•°æ® | ç”Ÿæˆæ—¶é—´ã€å®¡æ ¸çŠ¶æ€ã€å‘å¸ƒæ—¶é—´ |
| äº’åŠ¨æ•°æ® | é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€è¯„è®º |
| è¯„åˆ†æ•°æ® | AIè¯„åˆ†ã€çœŸå®è¯„åˆ†ã€é¢„æµ‹è¯¯å·® |

#### 4.6.2 AIè¯„åˆ†é—­ç¯

```
[AIé¢„æµ‹åˆ†æ•°] â†’ [å‘å¸ƒ] â†’ [ç­‰å¾…24-48h] â†’ [æŠ“å–çœŸå®æ•°æ®]
       â†“                                      â†“
[è®°å½•prediction_error] â† [è®¡ç®—real_score] â†â”˜
       â†“
[æ¯å‘¨åˆ†æ] â†’ [è°ƒæ•´è¯„åˆ†æƒé‡] â†’ [ä¼˜åŒ–Prompt]
```

**çœŸå®è¯„åˆ†å…¬å¼ï¼š**
```javascript
real_score =
  views_weight * (views / views_benchmark) * 10 +
  likes_weight * (likes / views) * 100 * 30 +
  collects_weight * (collects / views) * 100 * 30 +
  comments_weight * (comments / views) * 100 * 20;

// æƒé‡å‚è€ƒ
// views_benchmark = 1000
// likes_weight = 3.0 (ç‚¹èµç‡>5%ä¼˜ç§€)
// collects_weight = 5.0 (æ”¶è—ç‡>3%ä¼˜ç§€)
// comments_weight = 2.0 (è¯„è®ºç‡>1%ä¼˜ç§€)
```

---

### 4.7 AI Prompt ç‰ˆæœ¬ç®¡ç†è§„èŒƒ

#### 4.7.1 PROMPT_ID å‘½åçº¦å®š

æ‰€æœ‰ Prompt å¿…é¡»åˆ†é…å”¯ä¸€çš„ PROMPT_IDï¼Œå‘½åè§„åˆ™ï¼š

| PROMPT_ID | ç”¨é€” | æ–‡ä»¶è·¯å¾„ |
|-----------|------|----------|
| `TOPIC_GEN` | é€‰é¢˜ç”Ÿæˆ | `config/prompts/topic_generation.md` |
| `CONTENT_GEN` | å†…å®¹åˆ›ä½œ | `config/prompts/content_creation.md` |
| `REVIEW_STEP0` | è´¦å·å®šä½å®¡æ ¸ | `config/prompts/review_steps.md` |
| `REVIEW_STEP1` | ä¸‰ç§’æµ‹è¯•å®¡æ ¸ | `config/prompts/review_steps.md` |
| `REVIEW_STEP2` | é¦–å±æµ‹è¯•å®¡æ ¸ | `config/prompts/review_steps.md` |
| `REVIEW_STEP3` | å…¨æ–‡è´¨é‡å®¡æ ¸ | `config/prompts/review_steps.md` |
| `REVIEW_STEP4` | äº’åŠ¨è®¾è®¡å®¡æ ¸ | `config/prompts/review_steps.md` |
| `REVIEW_STEP5` | å¹³å°åˆè§„å®¡æ ¸ | `config/prompts/review_steps.md` |
| `IMAGE_DESC` | å›¾ç‰‡æè¿°ç”Ÿæˆ | `config/prompts/image_prompt.md` |
| `SCORE_CALC` | è¯„åˆ†è®¡ç®— | `config/prompts/score_calculation.md` |

#### 4.7.2 VERSION ç®¡ç†æœºåˆ¶

ç‰ˆæœ¬å·æ ¼å¼ï¼š`V{major}.{minor}`ï¼Œä¾‹å¦‚ `V1`, `V1.1`, `V2`

**ç‰ˆæœ¬æ³¨å†Œè¡¨ (config/prompt_registry.json)ï¼š**

```json
{
  "prompts": [
    {
      "prompt_id": "TOPIC_GEN",
      "current_version": "V1",
      "versions": [
        {
          "version": "V1",
          "created_at": "2024-12-11",
          "description": "åˆå§‹ç‰ˆæœ¬",
          "file_path": "config/prompts/topic_generation.md",
          "status": "active"
        }
      ]
    },
    {
      "prompt_id": "CONTENT_GEN",
      "current_version": "V1",
      "versions": [
        {
          "version": "V1",
          "created_at": "2024-12-11",
          "description": "åˆå§‹ç‰ˆæœ¬",
          "file_path": "config/prompts/content_creation.md",
          "status": "active"
        }
      ]
    }
  ],
  "last_updated": "2024-12-11"
}
```

#### 4.7.3 Prompt ä½¿ç”¨è®°å½•

æ¯æ¬¡ AI è°ƒç”¨å¿…é¡»åœ¨ `content_records` å’Œ `execution_logs` ä¸­è®°å½•ä½¿ç”¨çš„ Promptï¼š

**content_records æ–°å¢å­—æ®µï¼š**
- `prompt_id`: ä½¿ç”¨çš„ Prompt ID
- `prompt_version`: ä½¿ç”¨çš„ Prompt ç‰ˆæœ¬

**execution_logs è®°å½•æ ¼å¼ï¼š**
```json
{
  "event_type": "AI_PROMPT_USED",
  "context": {
    "prompt_id": "CONTENT_GEN",
    "prompt_version": "V1",
    "task_type": "create_content"
  }
}
```

#### 4.7.4 Prompt æ›´æ–°æµç¨‹

1. **æ–°å»ºç‰ˆæœ¬**ï¼šå¤åˆ¶å½“å‰ Promptï¼Œä¿®æ”¹ç‰ˆæœ¬å·ä¸º V{n+1}
2. **æµ‹è¯•éªŒè¯**ï¼šä½¿ç”¨ TEST æ¨¡å¼åœ¨é‡‘æ•°æ®ä¸ŠéªŒè¯æ–° Prompt
3. **ç°åº¦å‘å¸ƒ**ï¼šé…ç½® `prompt_registry.json` ä¸­çš„æµé‡æ¯”ä¾‹
4. **å…¨é‡åˆ‡æ¢**ï¼šéªŒè¯é€šè¿‡åï¼Œæ›´æ–° `current_version`
5. **å½’æ¡£æ—§ç‰ˆ**ï¼šå°†æ—§ç‰ˆæœ¬ `status` æ”¹ä¸º `archived`

---

## 6. æ•°æ®åº“è®¾è®¡ä¸å®ç°

æœ¬ç³»ç»Ÿé‡‡ç”¨åŒæ•°æ®åº“æ¶æ„ï¼š
- **PostgreSQL**ï¼šçˆ†æ¬¾é‡‡é›†å¹³å°çš„ä¸»æ•°æ®åº“
- **é£ä¹¦å¤šç»´è¡¨æ ¼**ï¼šN8N å·¥ä½œæµçš„æ•°æ®å­˜å‚¨

### 6.1 PostgreSQL æ•°æ®åº“è®¾è®¡ (çˆ†æ¬¾é‡‡é›†å¹³å°)

#### Prisma Schema å®Œæ•´å®šä¹‰

```prisma
// apps/web/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ç¬”è®°ç›¸å…³ ====================

/// é‡‡é›†çš„å°çº¢ä¹¦ç¬”è®°
model Note {
  id            String      @id @default(cuid())
  noteId        String      @unique                // å°çº¢ä¹¦ç¬”è®°ID
  title         String                             // ç¬”è®°æ ‡é¢˜
  content       String?     @db.Text               // ç¬”è®°æ­£æ–‡
  cover         String?                            // å°é¢å›¾URL
  noteUrl       String                             // ç¬”è®°é“¾æ¥
  noteType      NoteType    @default(IMAGE)        // å›¾æ–‡/è§†é¢‘

  // ä½œè€…ä¿¡æ¯
  authorId      String                             // ä½œè€…ID
  authorName    String                             // ä½œè€…æ˜µç§°
  authorAvatar  String?                            // ä½œè€…å¤´åƒ

  // äº’åŠ¨æ•°æ®
  likes         Int         @default(0)            // ç‚¹èµæ•°
  collects      Int         @default(0)            // æ”¶è—æ•°
  comments      Int         @default(0)            // è¯„è®ºæ•°
  shares        Int         @default(0)            // åˆ†äº«æ•°

  // æ ‡ç­¾
  tags          String[]                           // æ ‡ç­¾æ•°ç»„

  // é‡‡é›†ä¿¡æ¯
  keyword       String?                            // é‡‡é›†æ—¶çš„å…³é”®è¯
  source        CrawlSource @default(SEARCH)       // æ¥æº
  crawledAt     DateTime    @default(now())        // é‡‡é›†æ—¶é—´

  // åˆ†ææ•°æ®
  hotScore      Float?                             // çˆ†æ¬¾è¯„åˆ† (AIè®¡ç®—)
  category      String?                            // AI åˆ†ç±»

  // ç”¨æˆ·æ“ä½œ
  isStarred     Boolean     @default(false)        // æ˜¯å¦æ”¶è—
  isUsed        Boolean     @default(false)        // æ˜¯å¦å·²ç”¨äºé€‰é¢˜
  usedAt        DateTime?                          // ç”¨äºé€‰é¢˜çš„æ—¶é—´

  // å…³è”
  collections   NoteCollection[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([keyword])
  @@index([authorId])
  @@index([likes])
  @@index([crawledAt])
  @@index([isUsed])
}

enum NoteType {
  IMAGE   // å›¾æ–‡ç¬”è®°
  VIDEO   // è§†é¢‘ç¬”è®°
}

enum CrawlSource {
  SEARCH    // å…³é”®è¯æœç´¢
  AUTHOR    // ä½œè€…ä¸»é¡µ
  HOT       // çƒ­é—¨æ¨è
  TOPIC     // è¯é¢˜é¡µé¢
}

// ==================== ä½œè€…ç›‘æ§ ====================

/// ç›‘æ§çš„å°çº¢ä¹¦ä½œè€…
model Author {
  id            String    @id @default(cuid())
  authorId      String    @unique                  // å°çº¢ä¹¦ç”¨æˆ·ID
  name          String                             // æ˜µç§°
  avatar        String?                            // å¤´åƒ
  redId         String?                            // å°çº¢ä¹¦å·

  followers     Int       @default(0)              // ç²‰ä¸æ•°
  following     Int       @default(0)              // å…³æ³¨æ•°
  likes         Int       @default(0)              // è·èµæ•°

  isMonitoring  Boolean   @default(true)           // æ˜¯å¦ç›‘æ§ä¸­
  lastCrawledAt DateTime?                          // æœ€åé‡‡é›†æ—¶é—´

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isMonitoring])
}

// ==================== å…³é”®è¯ç®¡ç† ====================

/// ç›‘æ§çš„å…³é”®è¯
model Keyword {
  id              String    @id @default(cuid())
  keyword         String    @unique                // å…³é”®è¯
  category        String?                          // åˆ†ç±»

  minLikes        Int       @default(500)          // æœ€ä½ç‚¹èµé˜ˆå€¼
  isActive        Boolean   @default(true)         // æ˜¯å¦å¯ç”¨

  // ç»Ÿè®¡
  totalNotes      Int       @default(0)            // é‡‡é›†çš„ç¬”è®°æ€»æ•°
  lastCrawledAt   DateTime?                        // æœ€åé‡‡é›†æ—¶é—´

  // å®šæ—¶è®¾ç½®
  cronExpression  String?                          // å®šæ—¶è¡¨è¾¾å¼

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([isActive])
}

// ==================== é‡‡é›†ä»»åŠ¡ ====================

/// é‡‡é›†ä»»åŠ¡è®°å½•
model CrawlTask {
  id            String      @id @default(cuid())
  type          TaskType                           // ä»»åŠ¡ç±»å‹
  status        TaskStatus  @default(PENDING)      // ä»»åŠ¡çŠ¶æ€

  // ä»»åŠ¡å‚æ•°
  params        Json                               // { keyword, authorId, etc }

  // æ‰§è¡Œç»“æœ
  result        Json?                              // æ‰§è¡Œç»“æœ
  notesCount    Int?                               // é‡‡é›†ç¬”è®°æ•°
  errorMessage  String?                            // é”™è¯¯ä¿¡æ¯

  // æ—¶é—´
  startedAt     DateTime?                          // å¼€å§‹æ—¶é—´
  completedAt   DateTime?                          // å®Œæˆæ—¶é—´

  createdAt     DateTime    @default(now())

  @@index([status])
  @@index([createdAt])
}

enum TaskType {
  SEARCH_KEYWORD    // å…³é”®è¯æœç´¢
  CRAWL_AUTHOR      // ä½œè€…é‡‡é›†
  CRAWL_HOT         // çƒ­é—¨é‡‡é›†
  CRAWL_TOPIC       // è¯é¢˜é‡‡é›†
}

enum TaskStatus {
  PENDING     // ç­‰å¾…ä¸­
  RUNNING     // è¿è¡Œä¸­
  COMPLETED   // å·²å®Œæˆ
  FAILED      // å¤±è´¥
  CANCELLED   // å·²å–æ¶ˆ
}

// ==================== æ”¶è—å¤¹ ====================

/// ç¬”è®°æ”¶è—å¤¹
model Collection {
  id          String    @id @default(cuid())
  name        String                               // æ”¶è—å¤¹åç§°
  description String?                              // æè¿°

  notes       NoteCollection[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

/// ç¬”è®°-æ”¶è—å¤¹å…³è”è¡¨
model NoteCollection {
  note         Note       @relation(fields: [noteId], references: [id], onDelete: Cascade)
  noteId       String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String

  addedAt      DateTime   @default(now())

  @@id([noteId, collectionId])
}

// ==================== è´¦å·ç®¡ç† ====================

/// å°çº¢ä¹¦è´¦å· Cookie
model XhsAccount {
  id          String    @id @default(cuid())
  name        String                               // è´¦å·å¤‡æ³¨å
  cookies     String    @db.Text                   // Cookie JSON (åŠ å¯†å­˜å‚¨)

  isActive    Boolean   @default(true)             // æ˜¯å¦å¯ç”¨
  lastUsedAt  DateTime?                            // æœ€åä½¿ç”¨æ—¶é—´

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
}

// ==================== ç³»ç»Ÿé…ç½® ====================

/// ç³»ç»Ÿé…ç½®è¡¨
model SystemConfig {
  id          String    @id @default(cuid())
  key         String    @unique                    // é…ç½®é”®
  value       String    @db.Text                   // é…ç½®å€¼

  updatedAt   DateTime  @updatedAt
}
```

#### æ•°æ®åº“ç´¢å¼•ç­–ç•¥

| è¡¨å | ç´¢å¼•å­—æ®µ | ç±»å‹ | ç”¨é€” |
|------|----------|------|------|
| `notes` | `keyword` | B-tree | å…³é”®è¯ç­›é€‰ |
| `notes` | `likes` | B-tree | ç‚¹èµæ•°æ’åº |
| `notes` | `crawledAt` | B-tree | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| `notes` | `isUsed` | B-tree | æœªä½¿ç”¨ç¬”è®°ç­›é€‰ |
| `crawl_tasks` | `status` | B-tree | ä»»åŠ¡çŠ¶æ€ç­›é€‰ |
| `crawl_tasks` | `createdAt` | B-tree | ä»»åŠ¡å†å²æŸ¥è¯¢ |

#### å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

```typescript
// è·å–çˆ†æ¬¾ç¬”è®° (ç”¨äº N8N)
const hotNotes = await prisma.note.findMany({
  where: {
    likes: { gte: 1000 },
    isUsed: false,
    crawledAt: { gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) }
  },
  orderBy: { likes: 'desc' },
  take: 10
});

// è·å–å…³é”®è¯é‡‡é›†ç»Ÿè®¡
const keywordStats = await prisma.keyword.findMany({
  where: { isActive: true },
  select: {
    keyword: true,
    totalNotes: true,
    lastCrawledAt: true,
    _count: {
      select: { notes: { where: { likes: { gte: 1000 } } } }
    }
  }
});

// é‡‡é›†è¶‹åŠ¿åˆ†æ (æŒ‰å¤©ç»Ÿè®¡)
const trendData = await prisma.$queryRaw`
  SELECT DATE(crawled_at) as date, COUNT(*) as count
  FROM notes
  WHERE crawled_at >= NOW() - INTERVAL '7 days'
  GROUP BY DATE(crawled_at)
  ORDER BY date
`;
```

### 6.2 é£ä¹¦å¤šç»´è¡¨æ ¼ç»“æ„ (N8N å·¥ä½œæµ)

#### è¡¨1ï¼šcontent_records (å†…å®¹è®°å½•è¡¨)

| å­—æ®µå | é£ä¹¦ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|----------|------|------|
| id | å•è¡Œæ–‡æœ¬ | PK | UUIDä¸»é”® |
| created_at | æ—¥æœŸ | NOT NULL | åˆ›å»ºæ—¶é—´ |
| content_direction | å•é€‰ | NOT NULL | å†…å®¹æ–¹å‘ |
| topic_source | å•é€‰ | NOT NULL | ai/hot_trend/manual |
| title | å•è¡Œæ–‡æœ¬ | NOT NULL | æ ‡é¢˜15-30å­— |
| content_body | å¤šè¡Œæ–‡æœ¬ | NOT NULL | æ­£æ–‡800-1200å­— |
| tags | å¤šé€‰ | NOT NULL | æ ‡ç­¾æ•°ç»„ |
| image_url | é™„ä»¶ | - | å›¾ç‰‡URL |
| ai_score | æ•°å­— | NOT NULL | AIè¯„åˆ†0-100 |
| real_score | æ•°å­— | - | çœŸå®è¯„åˆ† |
| prediction_error | æ•°å­— | - | é¢„æµ‹è¯¯å·® |
| status | å•é€‰ | NOT NULL | çŠ¶æ€(è§çŠ¶æ€æœº) |
| published_at | æ—¥æœŸ | - | å‘å¸ƒæ—¶é—´ |
| account_id | å…³è” | FK | å…³è”è´¦å· |
| workflow_run_id | å•è¡Œæ–‡æœ¬ | UNIQUE | N8Næ‰§è¡ŒID |
| prompt_id | å•è¡Œæ–‡æœ¬ | NOT NULL | ä½¿ç”¨çš„Prompt ID |
| prompt_version | å•è¡Œæ–‡æœ¬ | NOT NULL | ä½¿ç”¨çš„Promptç‰ˆæœ¬ |
| views | æ•°å­— | - | é˜…è¯»é‡ |
| likes | æ•°å­— | - | ç‚¹èµæ•° |
| collects | æ•°å­— | - | æ”¶è—æ•° |
| comments | æ•°å­— | - | è¯„è®ºæ•° |

**å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š**

| åœºæ™¯ | æŸ¥è¯¢æ¡ä»¶ | ç”¨é€” |
|------|----------|------|
| å¾…å®¡æ ¸åˆ—è¡¨ | `status = 'AI_REVIEWED'` ORDER BY `created_at` DESC | äººå·¥å®¡æ ¸é˜Ÿåˆ— |
| ä»Šæ—¥å‘å¸ƒ | `published_at >= TODAY` AND `account_id = ?` | é™é¢‘æ£€æŸ¥ |
| é«˜åˆ†å†…å®¹åˆ†æ | `ai_score >= 85` AND `status = 'PUBLISHED'` | æå–æˆåŠŸæ¨¡å¼ |
| Promptæ•ˆæœå¯¹æ¯” | GROUP BY `prompt_id`, `prompt_version` AVG(`real_score`) | Prompt A/Bæµ‹è¯• |
| é¢„æµ‹è¯¯å·®åˆ†æ | `prediction_error > 15` ORDER BY `prediction_error` DESC | æ¨¡å‹æ ¡å‡† |

#### è¡¨2ï¼šaccounts (è´¦å·ç®¡ç†è¡¨)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | å•è¡Œæ–‡æœ¬ | è´¦å·ID |
| name | å•è¡Œæ–‡æœ¬ | è´¦å·åç§° |
| status | å•é€‰ | ACTIVE/COOLDOWN/SUSPENDED/BANNED |
| last_publish_at | æ—¥æœŸ | æœ€åå‘å¸ƒæ—¶é—´ |
| publish_count_today | æ•°å­— | ä»Šæ—¥å‘å¸ƒæ•° |
| cooldown_until | æ—¥æœŸ | å†·å´æˆªæ­¢æ—¶é—´ |

**å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š**

| åœºæ™¯ | æŸ¥è¯¢æ¡ä»¶ | ç”¨é€” |
|------|----------|------|
| å¯ç”¨è´¦å· | `status = 'ACTIVE'` AND `publish_count_today < 3` | å‘å¸ƒè°ƒåº¦ |
| å†·å´æ£€æŸ¥ | `status = 'COOLDOWN'` AND `cooldown_until <= NOW` | è‡ªåŠ¨æ¢å¤ |
| è´¦å·å¥åº· | GROUP BY `status` COUNT(*) | è¿è¥ç›‘æ§ |

#### è¡¨3ï¼šexecution_logs (æ‰§è¡Œæ—¥å¿—è¡¨)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| timestamp | æ—¥æœŸ | æ—¶é—´æˆ³ |
| level | å•é€‰ | DEBUG/INFO/WARN/ERROR/FATAL |
| workflow_id | å•è¡Œæ–‡æœ¬ | å·¥ä½œæµID |
| workflow_run_id | å•è¡Œæ–‡æœ¬ | æ‰§è¡ŒID |
| node_name | å•è¡Œæ–‡æœ¬ | èŠ‚ç‚¹å |
| event_type | å•é€‰ | äº‹ä»¶ç±»å‹ï¼ˆè§5.3æšä¸¾ï¼‰ |
| message | å¤šè¡Œæ–‡æœ¬ | æ—¥å¿—æ¶ˆæ¯ |
| context | å¤šè¡Œæ–‡æœ¬ | JSONä¸Šä¸‹æ–‡ |
| error | å¤šè¡Œæ–‡æœ¬ | JSONé”™è¯¯ä¿¡æ¯ |

**å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š**

| åœºæ™¯ | æŸ¥è¯¢æ¡ä»¶ | ç”¨é€” |
|------|----------|------|
| é”™è¯¯æ’æŸ¥ | `workflow_run_id = ?` AND `level IN ('ERROR', 'FATAL')` | æ•…éšœå®šä½ |
| APIæˆæœ¬ | `event_type = 'AI_API_CALL'` GROUP BY DATE(`timestamp`) | æˆæœ¬ç›‘æ§ |
| å‘å¸ƒå¤±è´¥ | `event_type = 'PUBLISH_FAILED'` ORDER BY `timestamp` DESC | é—®é¢˜è¿½è¸ª |
| æ—¥æ‰§è¡Œç»Ÿè®¡ | `timestamp >= TODAY` GROUP BY `workflow_id`, `level` | å¥åº·çœ‹æ¿ |

#### è¡¨4ï¼šinteraction_data (äº’åŠ¨æ•°æ®è¡¨)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| content_id | å•è¡Œæ–‡æœ¬ | å…³è”å†…å®¹ID |
| fetched_at | æ—¥æœŸ | æŠ“å–æ—¶é—´ |
| views | æ•°å­— | é˜…è¯»é‡ |
| likes | æ•°å­— | ç‚¹èµæ•° |
| collects | æ•°å­— | æ”¶è—æ•° |
| comments | æ•°å­— | è¯„è®ºæ•° |

**å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š**

| åœºæ™¯ | æŸ¥è¯¢æ¡ä»¶ | ç”¨é€” |
|------|----------|------|
| å¢é•¿è¶‹åŠ¿ | `content_id = ?` ORDER BY `fetched_at` | å•ç¯‡å†…å®¹åˆ†æ |
| 24hæ•°æ® | `fetched_at >= CONTENT.published_at + 24h` | çœŸå®è¯„åˆ†è®¡ç®— |

### 5.2 çŠ¶æ€æœºè®¾è®¡

#### å†…å®¹çŠ¶æ€æµè½¬

```
                    score â‰¥ 70
[DRAFT] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [AI_REVIEWED]
   â”‚                                     â”‚
   â”‚ score < 70                          â”‚ human_approve
   â†“                                     â†“
[REJECTED]                        [PENDING_APPROVAL]
                                         â”‚
                                         â”‚ publish_trigger
                                         â†“
                                   [PUBLISHING]
                                    â†™        â†˜
                          success â†™            â†˜ fail (retryâ‰¥3)
                                â†“                â†“
                          [PUBLISHED]        [FAILED]
                                                 â”‚
                                                 â”‚ retry
                                                 â†“
                                          [PENDING_APPROVAL]
```

#### çŠ¶æ€å®šä¹‰

| çŠ¶æ€ç  | åç§° | å¯è½¬æ¢åˆ° |
|--------|------|----------|
| DRAFT | è‰ç¨¿ | AI_REVIEWED, REJECTED |
| AI_REVIEWED | AIé€šè¿‡ | PENDING_APPROVAL, ARCHIVED |
| PENDING_APPROVAL | å¾…å‘å¸ƒ | PUBLISHING |
| PUBLISHING | å‘å¸ƒä¸­ | PUBLISHED, FAILED |
| PUBLISHED | å·²å‘å¸ƒ | - |
| REJECTED | AIæ‹’ç» | - |
| ARCHIVED | å·²å½’æ¡£ | - |
| FAILED | å‘å¸ƒå¤±è´¥ | PENDING_APPROVAL |

#### è´¦å·çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ | å‘å¸ƒè¡Œä¸º |
|------|------|----------|
| ACTIVE | æ­£å¸¸ | å¯å‘å¸ƒ |
| COOLDOWN | å†·å´ä¸­ | æš‚åœå‘å¸ƒ |
| SUSPENDED | æš‚åœ | ç¦æ­¢å‘å¸ƒ |
| BANNED | å°ç¦ | ç¦æ­¢å‘å¸ƒ |

### 5.3 æ—¥å¿—äº‹ä»¶ç±»å‹æšä¸¾

ä¸ºä¿è¯æ—¥å¿—çš„è§„èŒƒæ€§å’Œå¯ç»Ÿè®¡æ€§ï¼Œ`execution_logs.event_type` å¿…é¡»ä½¿ç”¨ä»¥ä¸‹æšä¸¾å€¼ï¼š

#### 5.3.1 äº‹ä»¶ç±»å‹å®šä¹‰

| event_type | çº§åˆ« | æè¿° | å¿…å«contextå­—æ®µ |
|------------|------|------|----------------|
| **å·¥ä½œæµç”Ÿå‘½å‘¨æœŸ** |
| `WORKFLOW_START` | INFO | å·¥ä½œæµå¼€å§‹æ‰§è¡Œ | `trigger_type` |
| `WORKFLOW_SUCCESS` | INFO | å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ | `duration_ms` |
| `WORKFLOW_FAILED` | ERROR | å·¥ä½œæµæ‰§è¡Œå¤±è´¥ | `error_code`, `error_message` |
| **AIè°ƒç”¨ç›¸å…³** |
| `AI_API_CALL` | INFO | AI APIè°ƒç”¨å®Œæˆ | `task_type`, `prompt_id`, `prompt_version`, `input_tokens`, `output_tokens`, `cost_usd`, `duration_ms` |
| `AI_API_RETRY` | WARN | AI APIé‡è¯• | `retry_count`, `error_reason` |
| `AI_API_FAILED` | ERROR | AI APIå¤±è´¥ï¼ˆé‡è¯•è€—å°½ï¼‰ | `error_code`, `retry_count` |
| `AI_PROMPT_USED` | DEBUG | è®°å½•ä½¿ç”¨çš„Prompt | `prompt_id`, `prompt_version` |
| **å†…å®¹ç”Ÿå‘½å‘¨æœŸ** |
| `CONTENT_CREATED` | INFO | å†…å®¹ç”Ÿæˆå®Œæˆ | `content_id`, `ai_score` |
| `CONTENT_REVIEWED` | INFO | AIå®¡æ ¸å®Œæˆ | `content_id`, `review_result`, `score` |
| `CONTENT_APPROVED` | INFO | äººå·¥å®¡æ ¸é€šè¿‡ | `content_id`, `reviewer` |
| `CONTENT_REJECTED` | INFO | å†…å®¹è¢«æ‹’ç» | `content_id`, `reject_reason` |
| **å‘å¸ƒç›¸å…³** |
| `PUBLISH_START` | INFO | å¼€å§‹å‘å¸ƒ | `content_id`, `account_id` |
| `PUBLISH_SUCCESS` | INFO | å‘å¸ƒæˆåŠŸ | `content_id`, `post_url` |
| `PUBLISH_FAILED` | ERROR | å‘å¸ƒå¤±è´¥ | `content_id`, `error_code`, `retry_count` |
| `PUBLISH_RATE_LIMITED` | WARN | è§¦å‘é™é¢‘ | `account_id`, `reason` |
| **æ•°æ®å›æµ** |
| `DATA_FETCH_START` | INFO | å¼€å§‹æŠ“å–æ•°æ® | `content_id` |
| `DATA_FETCH_SUCCESS` | INFO | æ•°æ®æŠ“å–æˆåŠŸ | `content_id`, `views`, `likes`, `collects`, `comments` |
| `DATA_FETCH_FAILED` | ERROR | æ•°æ®æŠ“å–å¤±è´¥ | `content_id`, `error_reason` |
| `SCORE_CALCULATED` | INFO | çœŸå®è¯„åˆ†è®¡ç®—å®Œæˆ | `content_id`, `real_score`, `prediction_error` |
| **ç³»ç»Ÿäº‹ä»¶** |
| `CONFIG_LOADED` | DEBUG | é…ç½®åŠ è½½å®Œæˆ | `config_source` |
| `NOTIFICATION_SENT` | INFO | é€šçŸ¥å‘é€æˆåŠŸ | `channel`, `message_type` |
| `NOTIFICATION_FAILED` | ERROR | é€šçŸ¥å‘é€å¤±è´¥ | `channel`, `error_reason` |

#### 5.3.2 äº‹ä»¶ç±»å‹ä½¿ç”¨è§„èŒƒ

```javascript
// N8N FunctionèŠ‚ç‚¹ä¸­çš„æ—¥å¿—è®°å½•ç¤ºä¾‹
async function logEvent(eventType, level, message, context = {}) {
  const logEntry = {
    timestamp: new Date().toISOString(),
    level: level,
    workflow_id: $workflow.id,
    workflow_run_id: $execution.id,
    node_name: $node.name,
    event_type: eventType,  // å¿…é¡»ä½¿ç”¨æšä¸¾å€¼
    message: message,
    context: JSON.stringify(context),
    error: null
  };

  // å†™å…¥é£ä¹¦execution_logsè¡¨
  await larkAPI.insertRecord('execution_logs', logEntry);
}

// ä½¿ç”¨ç¤ºä¾‹
await logEvent('AI_API_CALL', 'INFO', 'Claude APIè°ƒç”¨æˆåŠŸ', {
  task_type: 'create_content',
  prompt_id: 'CONTENT_GEN',
  prompt_version: 'V1',
  input_tokens: 1500,
  output_tokens: 2000,
  cost_usd: 0.015,
  duration_ms: 3500
});
```

#### 5.3.3 å‘Šè­¦é…ç½®å»ºè®®

| äº‹ä»¶ç±»å‹ | è§¦å‘æ¡ä»¶ | å‘Šè­¦çº§åˆ« | å‘Šè­¦æ–¹å¼ |
|----------|----------|----------|----------|
| `WORKFLOW_FAILED` | ä»»æ„ä¸€æ¬¡ | é«˜ | Telegramå³æ—¶ |
| `AI_API_FAILED` | ä»»æ„ä¸€æ¬¡ | é«˜ | Telegramå³æ—¶ |
| `PUBLISH_FAILED` | åŒä¸€å†…å®¹3æ¬¡ | é«˜ | Telegramå³æ—¶ |
| `AI_API_RETRY` | 1å°æ—¶å†…>10æ¬¡ | ä¸­ | Telegramæ±‡æ€» |
| `PUBLISH_RATE_LIMITED` | ä»»æ„ä¸€æ¬¡ | ä¸­ | Telegramå³æ—¶ |
| `DATA_FETCH_FAILED` | è¿ç»­3æ¬¡ | ä½ | æ—¥æŠ¥æ±‡æ€» |

---

## 7. N8Nå·¥ä½œæµå¼€å‘è§„èŒƒ

### 7.1 å‘½åè§„èŒƒ

| å¯¹è±¡ | è§„åˆ™ | ç¤ºä¾‹ |
|------|------|------|
| å·¥ä½œæµ | [åŠŸèƒ½]_[ç‰ˆæœ¬] | content_generator_v1 |
| èŠ‚ç‚¹ | [åŠ¨è¯]_[å¯¹è±¡] | fetch_hot_topics |
| å˜é‡ | camelCase | selectedTopicId |
| å‡­è¯ | [æœåŠ¡]_[ç¯å¢ƒ] | claude_api_prod |
| å­æµç¨‹ | sub_[åŠŸèƒ½] | sub_ai_score |

### 7.2 å˜é‡ç®¡ç†åˆ†å±‚

| å±‚çº§ | å­˜å‚¨ä½ç½® | ç¤ºä¾‹ |
|------|----------|------|
| å…¨å±€é…ç½® | Environment Variables | API endpoints |
| ä¸šåŠ¡é…ç½® | é£ä¹¦configè¡¨ | é˜ˆå€¼ã€é£æ ¼ |
| è¿è¡Œå‚æ•° | Workflow Variables | batch_size |
| èŠ‚ç‚¹è¾“å‡º | $json / $("èŠ‚ç‚¹å") | åŠ¨æ€æ•°æ® |

### 7.3 é”™è¯¯å¤„ç†ç­–ç•¥

| å±‚çº§ | æ–¹å¼ | åœºæ™¯ |
|------|------|------|
| èŠ‚ç‚¹çº§ | Continue On Fail | APIè°ƒç”¨ |
| å·¥ä½œæµçº§ | Error Trigger | å…¨å±€å¼‚å¸¸ |
| ä¸šåŠ¡çº§ | æ¡ä»¶åˆ†æ”¯+é‡è¯• | AIå¤±è´¥/å‘å¸ƒå¤±è´¥ |

### 7.4 å­å·¥ä½œæµè®¾è®¡

**æ‹†åˆ†æ¡ä»¶ï¼š**
- èŠ‚ç‚¹æ•° > 15
- é€»è¾‘å¤ç”¨
- å¯ç‹¬ç«‹æµ‹è¯•
- éœ€è¦å¹¶å‘æ‰§è¡Œ

**å»ºè®®å­æµç¨‹ï¼š**

| å­æµç¨‹ | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|--------|------|------|------|
| sub_ai_score | AIè¯„åˆ† | æ ‡é¢˜/å†…å®¹ | scoreå¯¹è±¡ |
| sub_hot_topics | çƒ­ç‚¹æŠ“å– | å…³é”®è¯ | çƒ­ç‚¹æ•°ç»„ |
| sub_image_gen | å›¾ç‰‡ç”Ÿæˆ | prompt | å›¾ç‰‡URL |
| sub_publish | å†…å®¹å‘å¸ƒ | å†…å®¹å¯¹è±¡ | å‘å¸ƒç»“æœ |
| sub_notify | é€šçŸ¥æ¨é€ | æ¶ˆæ¯ | å‘é€çŠ¶æ€ |

### 7.5 AI Gatewayè®¾è®¡

æ‰€æœ‰AIè°ƒç”¨ç»Ÿä¸€é€šè¿‡GatewayèŠ‚ç‚¹ï¼š

```javascript
// AI Gateway ä»£ç ç¤ºä¾‹
const request = {
  model: 'claude-sonnet-4-20250514',
  task_type: $json.task_type, // generate/score/review
  prompt_id: $json.prompt_id,
  prompt_version: $json.prompt_version,
  prompt: $json.prompt,
  max_tokens: $json.max_tokens || 4000
};

// é™é¢‘æ£€æŸ¥
const lastCallTime = $getWorkflowStaticData('lastCallTime') || 0;
if (Date.now() - lastCallTime < 1000) {
  await new Promise(r => setTimeout(r, 1000));
}

// è°ƒç”¨API
const startTime = Date.now();
const response = await claudeAPI.call(request);
const duration = Date.now() - startTime;

// è®°å½•æ—¥å¿—ï¼ˆå«Promptç‰ˆæœ¬ï¼‰
await logEvent('AI_API_CALL', 'INFO', 'Claude APIè°ƒç”¨æˆåŠŸ', {
  task_type: request.task_type,
  prompt_id: request.prompt_id,
  prompt_version: request.prompt_version,
  input_tokens: response.usage.input_tokens,
  output_tokens: response.usage.output_tokens,
  cost_usd: calculateCost(response.usage),
  duration_ms: duration
});

// æ›´æ–°é™é¢‘æ—¶é—´
$setWorkflowStaticData('lastCallTime', Date.now());

return { json: response };
```

### 6.6 å·¥ä½œæµæ¸…å•ï¼ˆWorkflow Catalogï¼‰

æœ¬èŠ‚é›†ä¸­åˆ—å‡ºæ‰€æœ‰å·¥ä½œæµçš„è¯¦ç»†å®šä¹‰ï¼Œä¾¿äºæŸ¥é˜…å’Œç»´æŠ¤ã€‚

#### 6.6.1 ä¸»å·¥ä½œæµæ¸…å•

##### content_generator_v1 - å†…å®¹ç”Ÿæˆå·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å·¥ä½œæµID** | `content_generator_v1` |
| **èŒè´£** | æ™ºèƒ½é€‰é¢˜ â†’ å†…å®¹ç”Ÿæˆ â†’ AIå®¡æ ¸ â†’ å›¾ç‰‡ç”Ÿæˆ â†’ å­˜å‚¨é€šçŸ¥ |
| **è§¦å‘æ–¹å¼** | Schedule Trigger (æ¯å¤©9:00) / Manual Trigger |
| **è¾“å…¥å‚æ•°** | `keyword`(å¿…å¡«), `target_audience`(å¯é€‰), `content_style`(å¯é€‰) |
| **è¾“å‡ºæ•°æ®** | `content_id`, `title`, `content_body`, `ai_score`, `status`, `image_url` |
| **æ¶‰åŠæ•°æ®è¡¨** | `content_records`, `execution_logs` |
| **è°ƒç”¨å­å·¥ä½œæµ** | `sub_hot_topics`, `sub_ai_score`, `sub_image_gen`, `sub_notify` |

**å…³é”®èŠ‚ç‚¹ï¼š**
```
Schedule_Trigger â†’ Fetch_Config â†’ AI_Gateway(generate_topic)
â†’ sub_hot_topics â†’ Match_Trends â†’ AI_Gateway(score_topics)
â†’ Select_Best â†’ AI_Gateway(create_content) â†’ sub_ai_score(5æ­¥å®¡æ ¸)
â†’ Branch_By_Score â†’ sub_image_gen â†’ Save_To_Lark â†’ sub_notify
```

**é”™è¯¯å¤„ç†ç­–ç•¥ï¼š**
| èŠ‚ç‚¹ | é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|------|----------|----------|
| AI_Gateway | RATE_LIMIT | ç­‰å¾…60sï¼Œé‡è¯•3æ¬¡ |
| AI_Gateway | TIMEOUT | å¢åŠ timeoutï¼Œé‡è¯•2æ¬¡ |
| sub_hot_topics | æŠ“å–å¤±è´¥ | è·³è¿‡çƒ­ç‚¹ï¼Œç»§ç»­æµç¨‹ |
| Save_To_Lark | å­˜å‚¨å¤±è´¥ | æœ¬åœ°ç¼“å­˜ï¼Œå®šæ—¶é‡è¯• |
| ä»»æ„èŠ‚ç‚¹ | æœªçŸ¥é”™è¯¯ | Error Trigger â†’ Telegramå‘Šè­¦ |

---

##### publish_scheduler_v1 - å‘å¸ƒè°ƒåº¦å·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å·¥ä½œæµID** | `publish_scheduler_v1` |
| **èŒè´£** | æ£€æŸ¥å‘å¸ƒé˜Ÿåˆ— â†’ é™é¢‘æ£€æŸ¥ â†’ è´¦å·è°ƒåº¦ â†’ MCPå‘å¸ƒ â†’ çŠ¶æ€æ›´æ–° |
| **è§¦å‘æ–¹å¼** | Schedule Trigger (æ¯å°æ—¶) / Webhook (äººå·¥è§¦å‘) |
| **è¾“å…¥å‚æ•°** | `content_id`(å¯é€‰ï¼ŒæŒ‡å®šå‘å¸ƒ), `account_id`(å¯é€‰ï¼ŒæŒ‡å®šè´¦å·) |
| **è¾“å‡ºæ•°æ®** | `publish_status`, `post_url`, `published_at` |
| **æ¶‰åŠæ•°æ®è¡¨** | `content_records`, `accounts`, `execution_logs` |
| **è°ƒç”¨å­å·¥ä½œæµ** | `sub_publish`, `sub_notify` |

**å…³é”®èŠ‚ç‚¹ï¼š**
```
Schedule_Trigger â†’ Fetch_Pending_Content â†’ Check_Account_Status
â†’ Rate_Limit_Check â†’ Select_Account â†’ sub_publish
â†’ Update_Content_Status â†’ Update_Account_Stats â†’ sub_notify
```

**é”™è¯¯å¤„ç†ç­–ç•¥ï¼š**
| èŠ‚ç‚¹ | é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|------|----------|----------|
| Check_Account_Status | æ— å¯ç”¨è´¦å· | è·³è¿‡æœ¬è½®ï¼Œè®°å½•WARN |
| Rate_Limit_Check | è§¦å‘é™é¢‘ | è·³è¿‡æœ¬è½®ï¼Œæ›´æ–°è´¦å·ä¸ºCOOLDOWN |
| sub_publish | MCPå¤±è´¥ | é‡è¯•3æ¬¡ï¼Œç„¶åæ ‡è®°FAILED |
| sub_publish | è´¦å·å°ç¦ | æ›´æ–°è´¦å·ä¸ºBANNEDï¼Œå‘Šè­¦ |

---

##### data_collector_v1 - æ•°æ®å›æµå·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å·¥ä½œæµID** | `data_collector_v1` |
| **èŒè´£** | å®šæ—¶æŠ“å–å·²å‘å¸ƒå†…å®¹çš„äº’åŠ¨æ•°æ® â†’ è®¡ç®—çœŸå®è¯„åˆ† â†’ æ›´æ–°é¢„æµ‹è¯¯å·® |
| **è§¦å‘æ–¹å¼** | Schedule Trigger (æ¯å¤©10:00, 22:00) |
| **è¾“å…¥å‚æ•°** | æ— ï¼ˆè‡ªåŠ¨æŸ¥è¯¢24-72hå‰å‘å¸ƒçš„å†…å®¹ï¼‰ |
| **è¾“å‡ºæ•°æ®** | `interaction_data`, `real_score`, `prediction_error` |
| **æ¶‰åŠæ•°æ®è¡¨** | `content_records`, `interaction_data`, `execution_logs` |
| **è°ƒç”¨å­å·¥ä½œæµ** | æ—  |

**å…³é”®èŠ‚ç‚¹ï¼š**
```
Schedule_Trigger â†’ Fetch_Published_Content(24-72h)
â†’ Loop_Each_Content â†’ Fetch_XHS_Data â†’ Calculate_Real_Score
â†’ Update_Content_Record â†’ Update_Interaction_Data â†’ Generate_Report
```

**é”™è¯¯å¤„ç†ç­–ç•¥ï¼š**
| èŠ‚ç‚¹ | é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|------|----------|----------|
| Fetch_XHS_Data | æŠ“å–å¤±è´¥ | è®°å½•å¤±è´¥ï¼Œè·³è¿‡è¯¥å†…å®¹ï¼Œç»§ç»­å¤„ç†å…¶ä»– |
| Fetch_XHS_Data | å†…å®¹è¢«åˆ  | æ ‡è®°å†…å®¹ä¸ºARCHIVED |
| Calculate_Real_Score | æ•°æ®å¼‚å¸¸ | è·³è¿‡è®¡ç®—ï¼Œè®°å½•WARN |

---

#### 6.6.2 å­å·¥ä½œæµæ¸…å•

##### sub_ai_score - AIè¯„åˆ†å­å·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å­å·¥ä½œæµID** | `sub_ai_score` |
| **èŒè´£** | æ‰§è¡Œ5æ­¥AIå®¡æ ¸ï¼Œè¿”å›ç»¼åˆè¯„åˆ† |
| **è¾“å…¥** | `{ title, content_body, tags, account_profile }` |
| **è¾“å‡º** | `{ score, step_scores[], review_comments, passed }` |
| **è¶…æ—¶è®¾ç½®** | 120s |

**èŠ‚ç‚¹æµç¨‹ï¼š**
```
Input â†’ AI_Gateway(REVIEW_STEP0) â†’ AI_Gateway(REVIEW_STEP1)
â†’ AI_Gateway(REVIEW_STEP2) â†’ AI_Gateway(REVIEW_STEP3)
â†’ AI_Gateway(REVIEW_STEP4) â†’ AI_Gateway(REVIEW_STEP5)
â†’ Calculate_Final_Score â†’ Output
```

---

##### sub_hot_topics - çƒ­ç‚¹æŠ“å–å­å·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å­å·¥ä½œæµID** | `sub_hot_topics` |
| **èŒè´£** | æŠ“å–æŠ–éŸ³/å¾®åšçƒ­æœï¼Œè¿”å›ç»“æ„åŒ–çƒ­ç‚¹åˆ—è¡¨ |
| **è¾“å…¥** | `{ keyword, max_results }` |
| **è¾“å‡º** | `{ hot_topics[], fetch_time }` |
| **è¶…æ—¶è®¾ç½®** | 30s |

**èŠ‚ç‚¹æµç¨‹ï¼š**
```
Input â†’ Parallel_Fetch[Douyin_Hot, Weibo_Hot]
â†’ Merge_Results â†’ Filter_By_Keyword â†’ Format_Output â†’ Output
```

---

##### sub_image_gen - å›¾ç‰‡ç”Ÿæˆå­å·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å­å·¥ä½œæµID** | `sub_image_gen` |
| **èŒè´£** | ç”Ÿæˆå›¾ç‰‡æè¿°Prompt â†’ è°ƒç”¨Geminiç”Ÿæˆå›¾ç‰‡ â†’ è¿”å›URL |
| **è¾“å…¥** | `{ title, topic, style }` |
| **è¾“å‡º** | `{ image_url, image_prompt }` |
| **è¶…æ—¶è®¾ç½®** | 60s |

**èŠ‚ç‚¹æµç¨‹ï¼š**
```
Input â†’ AI_Gateway(IMAGE_DESC) â†’ Gemini_API_Call
â†’ Upload_To_Storage â†’ Output
```

---

##### sub_publish - å†…å®¹å‘å¸ƒå­å·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å­å·¥ä½œæµID** | `sub_publish` |
| **èŒè´£** | è°ƒç”¨å°çº¢ä¹¦MCPæ‰§è¡Œå‘å¸ƒ |
| **è¾“å…¥** | `{ content_id, title, content_body, tags, image_url, account_id }` |
| **è¾“å‡º** | `{ success, post_url, error_message }` |
| **è¶…æ—¶è®¾ç½®** | 120s |
| **é‡è¯•ç­–ç•¥** | 3æ¬¡ï¼Œé—´éš”30s |

**èŠ‚ç‚¹æµç¨‹ï¼š**
```
Input â†’ Prepare_Publish_Data â†’ XHS_MCP_Call
â†’ Parse_Response â†’ Output
```

---

##### sub_notify - é€šçŸ¥æ¨é€å­å·¥ä½œæµ

| å±æ€§ | å€¼ |
|------|-----|
| **å­å·¥ä½œæµID** | `sub_notify` |
| **èŒè´£** | å‘é€Telegramé€šçŸ¥ |
| **è¾“å…¥** | `{ message_type, title, content, score, status }` |
| **è¾“å‡º** | `{ sent, message_id }` |
| **è¶…æ—¶è®¾ç½®** | 10s |

**èŠ‚ç‚¹æµç¨‹ï¼š**
```
Input â†’ Format_Message â†’ Telegram_Send â†’ Output
```

---

## 8. APIé›†æˆæŒ‡å—

### 8.1 Claude API

```javascript
// Claude API è°ƒç”¨ç¤ºä¾‹
const response = await fetch('https://api.anthropic.com/v1/messages', {
  method: 'POST',
  headers: {
    'x-api-key': process.env.CLAUDE_API_KEY,
    'anthropic-version': '2023-06-01',
    'content-type': 'application/json'
  },
  body: JSON.stringify({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 4000,
    messages: [{
      role: 'user',
      content: prompt
    }]
  })
});

const data = await response.json();
return data.content[0].text;
```

### 8.2 é£ä¹¦API

```javascript
// è·å–access_token
const tokenRes = await fetch('https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    app_id: process.env.LARK_APP_ID,
    app_secret: process.env.LARK_APP_SECRET
  })
});
const { tenant_access_token } = await tokenRes.json();

// æ’å…¥è®°å½•
const insertRes = await fetch(
  `https://open.feishu.cn/open-apis/bitable/v1/apps/${appToken}/tables/${tableId}/records`,
  {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${tenant_access_token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      fields: {
        id: 'uuid-xxx',
        title: 'å†…å®¹æ ‡é¢˜',
        ai_score: 85,
        status: 'AI_REVIEWED',
        prompt_id: 'CONTENT_GEN',
        prompt_version: 'V1'
      }
    })
  }
);
```

### 8.3 Telegram Bot

```javascript
// å‘é€é€šçŸ¥
const sendNotification = async (message) => {
  const url = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;
  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: CHAT_ID,
      text: message,
      parse_mode: 'Markdown'
    })
  });
};

// é€šçŸ¥æ¨¡æ¿
const notifyTemplate = `
*æ–°å†…å®¹ç”Ÿæˆå®Œæˆ*

**æ ‡é¢˜**: ${title}
**AIè¯„åˆ†**: ${score}/100
**çŠ¶æ€**: ${status}

${score >= 80 ? 'å¯ä»¥å‘å¸ƒ' : 'éœ€è¦ä¼˜åŒ–'}
`;
```

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•é¡¹ | æ–¹æ³• | æ ‡å‡† |
|--------|------|------|
| Promptè§£æ | è¾“å…¥å¤šç§æ ¼å¼æµ‹è¯• | 100%æ­£ç¡®è§£æ |
| è¯„åˆ†è®¡ç®— | è¾¹ç•Œå€¼æµ‹è¯• | ç»“æœå‡†ç¡® |
| çŠ¶æ€è½¬æ¢ | è¦†ç›–æ‰€æœ‰è½¬æ¢è·¯å¾„ | 100%æ­£ç¡® |
| APIè°ƒç”¨ | Mockæµ‹è¯• | æ­£ç¡®å¤„ç†å“åº” |

### 9.2 é›†æˆæµ‹è¯•

| æµ‹è¯•é¡¹ | æ–¹æ³• | æ ‡å‡† |
|--------|------|------|
| é€‰é¢˜ç”Ÿæˆ | è¿è¡Œ10æ¬¡ | åˆæ ¼ç‡â‰¥80% |
| å†…å®¹åˆ›ä½œ | äººå·¥è¯„å®¡10ç¯‡ | é€šè¿‡ç‡â‰¥85% |
| å›¾ç‰‡ç”Ÿæˆ | ç”Ÿæˆ20å¼ æ£€æŸ¥ | æˆåŠŸç‡â‰¥90% |
| å‘å¸ƒåŠŸèƒ½ | å®é™…å‘å¸ƒæµ‹è¯• | æˆåŠŸç‡â‰¥95% |
| æ•°æ®å­˜å‚¨ | é£ä¹¦è¡¨æ ¼æ ¸å¯¹ | 100%å®Œæ•´ |

### 9.3 æ€§èƒ½æµ‹è¯•

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|------|------|----------|
| å•ç¯‡ç”Ÿæˆæ—¶é—´ | â‰¤5min | 10æ¬¡å¹³å‡ |
| å·¥ä½œæµå“åº” | â‰¤10s | èŠ‚ç‚¹å¯åŠ¨è®¡æ—¶ |
| å¹¶å‘æ”¯æŒ | â‰¥3ä»»åŠ¡ | åŒæ—¶è¿è¡Œæµ‹è¯• |
| é”™è¯¯æ¢å¤ | â‰¥80% | æ¨¡æ‹Ÿé”™è¯¯æµ‹è¯• |

### 9.4 æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

```yaml
# tests/test_cases.yml

test_topic_generation:
  name: "é€‰é¢˜ç”Ÿæˆæµ‹è¯•"
  input:
    keyword: "AIè‡ªåŠ¨åŒ–"
    target_audience: "å¼€å‘è€…"
  expected:
    - topics_count: 3-5
    - each_score: ">= 70"
    - title_length: "15-30å­—"
  runs: 10
  pass_rate: ">= 80%"

test_content_creation:
  name: "å†…å®¹åˆ›ä½œæµ‹è¯•"
  input:
    title: "æµ‹è¯•æ ‡é¢˜"
    core_points: ["ç‚¹1", "ç‚¹2", "ç‚¹3"]
  expected:
    - word_count: "800-1200"
    - has_emoji: true
    - tags_count: "8-10"
  human_review: true

test_publish_flow:
  name: "å‘å¸ƒæµç¨‹æµ‹è¯•"
  preconditions:
    - account_status: "ACTIVE"
    - publish_count_today: "< 3"
  expected:
    - status_after: "PUBLISHED"
    - notification_sent: true
```

### 9.5 N8Nå·¥ä½œæµå›å½’æµ‹è¯•è§„èŒƒ

#### 9.5.1 TESTæ¨¡å¼è®¾è®¡

æ‰€æœ‰ä¸»å·¥ä½œæµå¿…é¡»æ”¯æŒ TEST æ¨¡å¼ï¼Œé€šè¿‡è¾“å…¥å‚æ•° `test_mode: true` å¯ç”¨ï¼š

**TESTæ¨¡å¼ç‰¹æ€§ï¼š**

| ç‰¹æ€§ | æ­£å¸¸æ¨¡å¼ | TESTæ¨¡å¼ |
|------|----------|----------|
| æ•°æ®å­˜å‚¨ | é£ä¹¦æ­£å¼è¡¨ | é£ä¹¦æµ‹è¯•è¡¨ï¼ˆè¡¨ååŠ  `_test` åç¼€ï¼‰ |
| å‘å¸ƒæ“ä½œ | çœŸå®å‘å¸ƒ | è·³è¿‡ï¼Œè¿”å›æ¨¡æ‹ŸæˆåŠŸ |
| é€šçŸ¥æ¨é€ | æ­£å¼é¢‘é“ | æµ‹è¯•é¢‘é“æˆ–è·³è¿‡ |
| APIè°ƒç”¨ | æ­£å¸¸è°ƒç”¨ | æ­£å¸¸è°ƒç”¨ï¼ˆè®°å½•åˆ°æµ‹è¯•æ—¥å¿—ï¼‰ |
| è´¹ç”¨è®¡å…¥ | ç”Ÿäº§ç»Ÿè®¡ | æµ‹è¯•ç»Ÿè®¡ï¼ˆç‹¬ç«‹è¿½è¸ªï¼‰ |

**TESTæ¨¡å¼è§¦å‘æ–¹å¼ï¼š**
```json
// Manual Trigger è¾“å…¥
{
  "test_mode": true,
  "keyword": "AIè‡ªåŠ¨åŒ–",
  "target_audience": "å¼€å‘è€…"
}
```

**å·¥ä½œæµä¸­çš„TESTæ¨¡å¼å¤„ç†ï¼š**
```javascript
// åœ¨Save_To_LarkèŠ‚ç‚¹ä¸­
const tableId = $json.test_mode
  ? process.env.LARK_TABLE_CONTENT_TEST
  : process.env.LARK_TABLE_CONTENT;

// åœ¨sub_publishèŠ‚ç‚¹ä¸­
if ($json.test_mode) {
  return {
    json: {
      success: true,
      post_url: 'https://test.xiaohongshu.com/mock/12345',
      test_mode: true
    }
  };
}
```

#### 9.5.2 é‡‘æ•°æ®æµ‹è¯•é›†

åœ¨ `tests/golden/` ç›®å½•ä¸‹ç»´æŠ¤å›ºå®šè¾“å…¥å’Œé¢„æœŸè¾“å‡ºçš„æµ‹è¯•ç”¨ä¾‹ï¼š

**ç›®å½•ç»“æ„ï¼š**
```
tests/golden/
â”œâ”€â”€ content_generator/
â”‚   â”œâ”€â”€ case_001_basic.json
â”‚   â”œâ”€â”€ case_002_hot_trend.json
â”‚   â””â”€â”€ case_003_edge_case.json
â”œâ”€â”€ publish_scheduler/
â”‚   â””â”€â”€ case_001_normal.json
â””â”€â”€ data_collector/
    â””â”€â”€ case_001_normal.json
```

**é‡‘æ•°æ®ç”¨ä¾‹æ ¼å¼ (case_001_basic.json)ï¼š**
```json
{
  "case_id": "CG_001",
  "case_name": "åŸºç¡€é€‰é¢˜ç”Ÿæˆ",
  "workflow": "content_generator_v1",
  "description": "éªŒè¯åŸºç¡€é€‰é¢˜ç”Ÿæˆæµç¨‹",
  "input": {
    "test_mode": true,
    "keyword": "AIè‡ªåŠ¨åŒ–",
    "target_audience": "å¼€å‘è€…",
    "content_style": "å¹²è´§æ•™ç¨‹"
  },
  "expected_output": {
    "structure": {
      "content_id": "string:uuid",
      "title": "string:length:15-30",
      "content_body": "string:length:800-1200",
      "ai_score": "number:range:0-100",
      "status": "enum:DRAFT|AI_REVIEWED|REJECTED",
      "tags": "array:length:8-10"
    },
    "business_rules": [
      { "rule": "ai_score >= 70", "implies": "status == AI_REVIEWED" },
      { "rule": "ai_score < 70", "implies": "status == REJECTED" }
    ]
  },
  "expected_logs": [
    { "event_type": "WORKFLOW_START" },
    { "event_type": "AI_API_CALL", "context.task_type": "generate_topic" },
    { "event_type": "AI_API_CALL", "context.task_type": "create_content" },
    { "event_type": "CONTENT_CREATED" },
    { "event_type": "WORKFLOW_SUCCESS" }
  ],
  "created_at": "2024-12-11",
  "last_verified": "2024-12-11"
}
```

#### 9.5.3 å›å½’æµ‹è¯•æ‰§è¡Œç­–ç•¥

**è§¦å‘æ—¶æœºï¼š**

| åœºæ™¯ | å¿…é¡»æ‰§è¡Œçš„å›å½’æµ‹è¯• |
|------|-------------------|
| ä¿®æ”¹ä¸»å·¥ä½œæµèŠ‚ç‚¹ | è¯¥å·¥ä½œæµæ‰€æœ‰é‡‘æ•°æ®ç”¨ä¾‹ |
| ä¿®æ”¹å­å·¥ä½œæµ | è°ƒç”¨è¯¥å­å·¥ä½œæµçš„æ‰€æœ‰ä¸»å·¥ä½œæµç”¨ä¾‹ |
| ä¿®æ”¹Prompt | ä½¿ç”¨è¯¥Promptçš„æ‰€æœ‰ç”¨ä¾‹ |
| ä¿®æ”¹æ•°æ®è¡¨ç»“æ„ | æ‰€æœ‰æ¶‰åŠè¯¥è¡¨çš„ç”¨ä¾‹ |
| æ¯å‘¨å®šæœŸ | å…¨é‡å›å½’æµ‹è¯• |

**å›å½’æµ‹è¯•è„šæœ¬ (tests/regression/run_tests.sh)ï¼š**
```bash
#!/bin/bash
# å›å½’æµ‹è¯•æ‰§è¡Œè„šæœ¬

WORKFLOW=$1  # å¯é€‰ï¼šæŒ‡å®šå·¥ä½œæµ
GOLDEN_DIR="tests/golden"
RESULTS_DIR="tests/results/$(date +%Y%m%d_%H%M%S)"

mkdir -p $RESULTS_DIR

# æ‰§è¡Œæµ‹è¯•
if [ -z "$WORKFLOW" ]; then
  # å…¨é‡æµ‹è¯•
  for case_file in $GOLDEN_DIR/**/*.json; do
    run_single_test "$case_file" "$RESULTS_DIR"
  done
else
  # æŒ‡å®šå·¥ä½œæµæµ‹è¯•
  for case_file in $GOLDEN_DIR/$WORKFLOW/*.json; do
    run_single_test "$case_file" "$RESULTS_DIR"
  done
fi

# ç”ŸæˆæŠ¥å‘Š
generate_report "$RESULTS_DIR"
```

**æµ‹è¯•ç»“æœéªŒè¯ï¼š**
```javascript
// tests/regression/validator.js
function validateOutput(actual, expected) {
  const errors = [];

  // ç»“æ„éªŒè¯
  for (const [field, rule] of Object.entries(expected.structure)) {
    const value = actual[field];
    if (!validateRule(value, rule)) {
      errors.push(`Field ${field} failed: expected ${rule}, got ${typeof value}`);
    }
  }

  // ä¸šåŠ¡è§„åˆ™éªŒè¯
  for (const rule of expected.business_rules) {
    if (evaluateCondition(actual, rule.rule)) {
      if (!evaluateCondition(actual, rule.implies)) {
        errors.push(`Business rule failed: ${rule.rule} => ${rule.implies}`);
      }
    }
  }

  return { passed: errors.length === 0, errors };
}
```

#### 9.5.4 æµ‹è¯•æŠ¥å‘Šæ ¼å¼

```markdown
# å›å½’æµ‹è¯•æŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: 2024-12-11 14:30:00
**æ‰§è¡Œç¯å¢ƒ**: TEST
**æ€»ç”¨ä¾‹æ•°**: 15
**é€šè¿‡æ•°**: 14
**å¤±è´¥æ•°**: 1
**é€šè¿‡ç‡**: 93.3%

## å¤±è´¥ç”¨ä¾‹è¯¦æƒ…

### CG_003 - è¾¹ç•Œæƒ…å†µæµ‹è¯•
- **å·¥ä½œæµ**: content_generator_v1
- **å¤±è´¥åŸå› **: ai_score = 69, status = AI_REVIEWED (åº”ä¸º REJECTED)
- **ç›¸å…³æ—¥å¿—**: workflow_run_id = test_run_xyz789

## å»ºè®®
- æ£€æŸ¥ Branch_By_Score èŠ‚ç‚¹çš„åˆ¤æ–­æ¡ä»¶
```

---

## 10. Chromeæ‰©å±•é›†æˆæŒ‡å—

æœ¬ç« ä»‹ç»é¡¹ç›®ä¸­é›†æˆçš„ Chrome æ‰©å±• (`n8n-xhs-chrome-extenison-main`)ï¼Œç”¨äºè¾…åŠ©å°çº¢ä¹¦å†…å®¹é‡‡é›†å’Œæ•°æ®æå–ã€‚

### 10.1 æ‰©å±•æ¦‚è¿°

#### 10.1.1 åŠŸèƒ½å®šä½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **é¡µé¢æ•°æ®æå–** | ä»å°çº¢ä¹¦é¡µé¢æå–ç¬”è®°å†…å®¹ã€äº’åŠ¨æ•°æ® |
| **Cookie ç®¡ç†** | è¾…åŠ©è·å–å’Œç®¡ç†å°çº¢ä¹¦ç™»å½• Cookie |
| **ä¸€é”®é‡‡é›†** | åœ¨æµè§ˆå°çº¢ä¹¦æ—¶å¿«é€Ÿé‡‡é›†å½“å‰ç¬”è®° |
| **ä¸ N8N é›†æˆ** | é€šè¿‡ Webhook å°†æ•°æ®æ¨é€åˆ° N8N å·¥ä½œæµ |

#### 10.1.2 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | é€‰å‹ | ç‰ˆæœ¬ |
|------|------|------|
| æ¡†æ¶ | React + Vite | React 19.x |
| è¯­è¨€ | TypeScript | 5.x |
| æ ·å¼ | Tailwind CSS | 3.x |
| æ„å»ºå·¥å…· | Vite | 6.x |
| Monorepo | Turborepo | 2.x |
| åŒ…ç®¡ç† | pnpm | 10.x |

### 10.2 é¡¹ç›®ç»“æ„

```
n8n-xhs-chrome-extenison-main/
â”œâ”€â”€ chrome-extension/               # Chrome æ‰©å±•ä¸»ç›®å½•
â”‚   â”œâ”€â”€ manifest.ts                 # æ‰©å±•é…ç½®æ¸…å•
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ background/             # Service Worker èƒŒæ™¯è„šæœ¬
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â””â”€â”€ public/
â”‚       â”œâ”€â”€ icon-128.png            # æ‰©å±•å›¾æ ‡
â”‚       â””â”€â”€ content.css             # æ³¨å…¥é¡µé¢çš„æ ·å¼
â”œâ”€â”€ packages/                       # å…±äº«åŒ…
â”‚   â”œâ”€â”€ dev-utils/                  # å¼€å‘å·¥å…·
â”‚   â”œâ”€â”€ env/                        # ç¯å¢ƒå˜é‡ç®¡ç†
â”‚   â”œâ”€â”€ hmr/                        # çƒ­æ¨¡å—æ›¿æ¢
â”‚   â”œâ”€â”€ i18n/                       # å›½é™…åŒ–
â”‚   â””â”€â”€ module-manager/             # æ¨¡å—ç®¡ç†å™¨
â”œâ”€â”€ docs/                           # æ–‡æ¡£
â”œâ”€â”€ package.json                    # é¡¹ç›®é…ç½®
â””â”€â”€ turbo.json                      # Turborepo é…ç½®
```

### 10.3 å¼€å‘ä¸æ„å»º

#### 10.3.1 ç¯å¢ƒå‡†å¤‡

```bash
# è¿›å…¥æ‰©å±•ç›®å½•
cd n8n-xhs-chrome-extenison-main

# å®‰è£…ä¾èµ– (éœ€è¦ Node.js >= 22.15.1)
pnpm install

# å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp .example.env .env
```

#### 10.3.2 å¼€å‘æ¨¡å¼

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (æ”¯æŒçƒ­æ›´æ–°)
pnpm dev

# Firefox å¼€å‘æ¨¡å¼
pnpm dev:firefox
```

#### 10.3.3 æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
# æ„å»º Chrome æ‰©å±•
pnpm build

# æ„å»º Firefox æ‰©å±•
pnpm build:firefox

# æ‰“åŒ…ä¸º ZIP (ç”¨äºå‘å¸ƒ)
pnpm zip
```

### 10.4 æ‰©å±•é…ç½®

#### 10.4.1 Manifest é…ç½®

æ‰©å±•é…ç½®æ–‡ä»¶ `chrome-extension/manifest.ts` å®šä¹‰äº†æ ¸å¿ƒæƒé™å’Œå†…å®¹è„šæœ¬ï¼š

```typescript
// å…³é”®é…ç½®
{
  manifest_version: 3,
  permissions: ['storage', 'scripting', 'tabs', 'notifications', 'sidePanel'],
  host_permissions: ['<all_urls>'],
  content_scripts: [
    {
      matches: ['https://www.xiaohongshu.com/user/profile/*'],
      js: ['content/xiaohongshu.iife.js'],
    }
  ]
}
```

#### 10.4.2 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env é…ç½®ç¤ºä¾‹
N8N_WEBHOOK_URL=https://your-n8n-domain.com/webhook/xxx
API_BASE_URL=https://your-api-domain.com
```

### 10.5 ä¸ N8N å·¥ä½œæµé›†æˆ

#### 10.5.1 æ•°æ®æ¨é€æµç¨‹

```
[ç”¨æˆ·æµè§ˆå°çº¢ä¹¦] â†’ [æ‰©å±•æå–æ•°æ®] â†’ [Webhook æ¨é€] â†’ [N8N å·¥ä½œæµ]
                                                      â†“
                                              [æ•°æ®å¤„ç†/å­˜å‚¨]
```

#### 10.5.2 Webhook æ•°æ®æ ¼å¼

```json
{
  "source": "chrome-extension",
  "action": "note_collected",
  "data": {
    "noteId": "xxx",
    "title": "ç¬”è®°æ ‡é¢˜",
    "content": "ç¬”è®°å†…å®¹",
    "author": "ä½œè€…åç§°",
    "authorId": "xxx",
    "likes": 1000,
    "collects": 500,
    "comments": 100,
    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"],
    "collectTime": "2024-12-11T10:00:00Z"
  }
}
```

#### 10.5.3 N8N Webhook èŠ‚ç‚¹é…ç½®

```javascript
// N8N Webhook èŠ‚ç‚¹è®¾ç½®
{
  "path": "xhs-extension-webhook",
  "httpMethod": "POST",
  "authentication": "headerAuth"  // å¯é€‰ï¼šæ·»åŠ è®¤è¯
}
```

### 10.6 å®‰è£…ä¸ä½¿ç”¨

#### 10.6.1 å¼€å‘ç‰ˆå®‰è£…

1. æ‰§è¡Œ `pnpm build` æ„å»ºæ‰©å±•
2. æ‰“å¼€ Chromeï¼Œè®¿é—® `chrome://extensions/`
3. å¯ç”¨ã€Œå¼€å‘è€…æ¨¡å¼ã€
4. ç‚¹å‡»ã€ŒåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºã€
5. é€‰æ‹© `dist/` ç›®å½•

#### 10.6.2 ä½¿ç”¨æ–¹æ³•

1. **è‡ªåŠ¨é‡‡é›†**ï¼šè®¿é—®å°çº¢ä¹¦ç”¨æˆ·ä¸»é¡µæ—¶ï¼Œæ‰©å±•è‡ªåŠ¨æ¿€æ´»
2. **æ‰‹åŠ¨é‡‡é›†**ï¼šç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼Œæ‰“å¼€ Popup é¢æ¿æ“ä½œ
3. **ä¾§è¾¹æ **ï¼šä½¿ç”¨ Side Panel æŸ¥çœ‹å·²é‡‡é›†æ•°æ®
4. **é€šçŸ¥**ï¼šé‡‡é›†æˆåŠŸ/å¤±è´¥æ—¶æ”¶åˆ°æµè§ˆå™¨é€šçŸ¥

### 10.7 å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| æ‰©å±•æ— æ³•åŠ è½½ | Node ç‰ˆæœ¬ä¸å¯¹ | ç¡®ä¿ Node >= 22.15.1 |
| å†…å®¹è„šæœ¬ä¸æ‰§è¡Œ | URL ä¸åŒ¹é… | æ£€æŸ¥ manifest ä¸­çš„ matches é…ç½® |
| Webhook æ¨é€å¤±è´¥ | ç½‘ç»œ/é…ç½®é—®é¢˜ | æ£€æŸ¥ N8N_WEBHOOK_URL é…ç½® |
| æƒé™ä¸è¶³ | æƒé™æœªå£°æ˜ | æ›´æ–° manifest permissions |

---

## 11. éƒ¨ç½²ä¸è¿ç»´æŒ‡å—

### 11.1 éƒ¨ç½²æ£€æŸ¥æ¸…å•

```markdown
## éƒ¨ç½²å‰æ£€æŸ¥

### æœåŠ¡å™¨
- [ ] æœåŠ¡å™¨é…ç½®æ»¡è¶³è¦æ±‚(2æ ¸4G+)
- [ ] Ubuntu 22.04 LTSå·²å®‰è£…
- [ ] Dockerå·²å®‰è£…å¹¶è¿è¡Œ
- [ ] é˜²ç«å¢™å·²é…ç½®(80, 443, 5678)

### åŸŸåä¸è¯ä¹¦
- [ ] åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨
- [ ] SSLè¯ä¹¦å·²é…ç½®
- [ ] HTTPSè®¿é—®æ­£å¸¸

### å‡­è¯é…ç½®
- [ ] Claude API Keyå·²é…ç½®
- [ ] Gemini API Keyå·²é…ç½®
- [ ] é£ä¹¦App ID/Secretå·²é…ç½®
- [ ] Telegram Bot Tokenå·²é…ç½®
- [ ] å°çº¢ä¹¦MCPå·²é…ç½®

### N8Né…ç½®
- [ ] å·¥ä½œæµå·²å¯¼å…¥
- [ ] å‡­è¯å·²ç»‘å®šèŠ‚ç‚¹
- [ ] è§¦å‘å™¨å·²å¯ç”¨
- [ ] æµ‹è¯•æ‰§è¡ŒæˆåŠŸ
```

### 11.2 å¤‡ä»½ç­–ç•¥

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½N8Næ•°æ®
docker exec n8n n8n export:workflow --all --output=/backups/workflows_${DATE}.json

# å¤‡ä»½æ•°æ®åº“(å¦‚æœæœ‰)
# docker exec db pg_dump -U user dbname > ${BACKUP_DIR}/db_${DATE}.sql

# ä¿ç•™æœ€è¿‘7å¤©å¤‡ä»½
find ${BACKUP_DIR} -name "*.json" -mtime +7 -delete

echo "Backup completed: ${DATE}"
```

### 11.3 å¥åº·æ£€æŸ¥

```bash
#!/bin/bash
# scripts/health_check.sh

# æ£€æŸ¥N8NæœåŠ¡
N8N_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5678/healthz)
if [ "$N8N_STATUS" != "200" ]; then
  echo "N8NæœåŠ¡å¼‚å¸¸!"
  # å‘é€å‘Šè­¦
fi

# æ£€æŸ¥Dockerå®¹å™¨
CONTAINERS=("n8n" "nginx")
for container in "${CONTAINERS[@]}"; do
  STATUS=$(docker inspect -f '{{.State.Running}}' $container 2>/dev/null)
  if [ "$STATUS" != "true" ]; then
    echo "å®¹å™¨ $container æœªè¿è¡Œ!"
    # å‘é€å‘Šè­¦
  fi
done

echo "Health check completed"
```

### 11.4 ç›‘æ§å‘Šè­¦

å»ºè®®é…ç½®ä»¥ä¸‹ç›‘æ§ï¼š

| ç›‘æ§é¡¹ | é˜ˆå€¼ | å‘Šè­¦æ–¹å¼ |
|--------|------|----------|
| CPUä½¿ç”¨ç‡ | > 80% | Telegram |
| å†…å­˜ä½¿ç”¨ç‡ | > 85% | Telegram |
| ç£ç›˜ç©ºé—´ | > 90% | Telegram |
| N8Næ‰§è¡Œå¤±è´¥ | è¿ç»­3æ¬¡ | Telegram |
| APIè°ƒç”¨å¤±è´¥ | è¿ç»­5æ¬¡ | Telegram |

### 11.5 å®‰å…¨ä¸ç¯å¢ƒç®¡ç†è§„èŒƒ

#### 11.5.1 ç¯å¢ƒåŒºåˆ†

æœ¬é¡¹ç›®æ”¯æŒä¸‰å¥—ç¯å¢ƒï¼Œé€šè¿‡ `.env` æ–‡ä»¶åŒºåˆ†ï¼š

| ç¯å¢ƒ | ç”¨é€” | é…ç½®æ–‡ä»¶ | é£ä¹¦è¡¨åç¼€ |
|------|------|----------|-----------|
| `dev` | æœ¬åœ°å¼€å‘ | `.env.dev` | `_dev` |
| `stage` | æµ‹è¯•éªŒè¯ | `.env.stage` | `_test` |
| `prod` | ç”Ÿäº§è¿è¡Œ | `.env.prod` | æ— åç¼€ |

**ç¯å¢ƒå˜é‡è§„èŒƒï¼š**
```bash
# .env.example (æäº¤åˆ°ç‰ˆæœ¬åº“çš„æ¨¡æ¿)
# ===== ç¯å¢ƒæ ‡è¯† =====
NODE_ENV=development  # development | staging | production

# ===== N8Né…ç½® =====
N8N_HOST=your-domain.com
N8N_PORT=5678
N8N_PROTOCOL=https

# ===== APIå¯†é’¥ (è¯·å‹¿æäº¤çœŸå®å€¼) =====
CLAUDE_API_KEY=sk-xxx-placeholder
GEMINI_API_KEY=xxx-placeholder
LARK_APP_ID=cli_xxx
LARK_APP_SECRET=xxx-placeholder
TELEGRAM_BOT_TOKEN=xxx-placeholder

# ===== é£ä¹¦è¡¨æ ¼ID =====
LARK_APP_TOKEN=xxx
LARK_TABLE_CONTENT=tblXXX
LARK_TABLE_CONTENT_TEST=tblXXX_test
LARK_TABLE_ACCOUNTS=tblXXX
LARK_TABLE_LOGS=tblXXX

# ===== é€šçŸ¥é…ç½® =====
TELEGRAM_CHAT_ID=xxx
TELEGRAM_CHAT_ID_TEST=xxx
```

#### 11.5.2 API Key ç®¡ç†è§„èŒƒ

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **ç¦æ­¢ç¡¬ç¼–ç ** | æ‰€æœ‰å¯†é’¥å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡æˆ–N8Nå‡­è¯ç®¡ç† |
| **ç¦æ­¢æäº¤** | `.env` æ–‡ä»¶å·²åŠ å…¥ `.gitignore`ï¼Œç¦æ­¢æäº¤çœŸå®å¯†é’¥ |
| **å®šæœŸè½®æ¢** | ç”Ÿäº§ç¯å¢ƒAPI Keyæ¯90å¤©è½®æ¢ä¸€æ¬¡ |
| **æœ€å°æƒé™** | é£ä¹¦Appä»…å¼€é€šå¿…è¦çš„APIæƒé™ |
| **ç‹¬ç«‹è´¦å·** | dev/stage/prodä½¿ç”¨ç‹¬ç«‹çš„APIè´¦å· |

**N8Nå‡­è¯ç®¡ç†ï¼š**
```
N8N UI â†’ Settings â†’ Credentials
â”œâ”€â”€ claude_api_dev     # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ claude_api_stage   # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ claude_api_prod    # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ lark_api_dev
â”œâ”€â”€ lark_api_stage
â”œâ”€â”€ lark_api_prod
â””â”€â”€ ...
```

#### 11.5.3 æ•æ„Ÿæ–‡ä»¶æ¸…å•

ä»¥ä¸‹æ–‡ä»¶**ç¦æ­¢æäº¤**åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼š

```gitignore
# .gitignore å¿…é¡»åŒ…å«

# ç¯å¢ƒå˜é‡
.env
.env.*
!.env.example

# N8Næ•°æ®ï¼ˆå«å‡­è¯ï¼‰
n8n_data/

# å¤‡ä»½æ–‡ä»¶
backups/

# SSLè¯ä¹¦
nginx/ssl/

# æ—¥å¿—æ–‡ä»¶
*.log
logs/
```

#### 11.5.4 éƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥

```bash
#!/bin/bash
# scripts/security_check.sh

echo "=== å®‰å…¨æ£€æŸ¥ ==="

# æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶è¢«è·Ÿè¸ª
SENSITIVE_FILES=$(git ls-files | grep -E '\.env$|credentials|secret|password')
if [ -n "$SENSITIVE_FILES" ]; then
  echo "[ERROR] æ•æ„Ÿæ–‡ä»¶è¢«ç‰ˆæœ¬æ§åˆ¶: $SENSITIVE_FILES"
  exit 1
fi

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®
REQUIRED_VARS=("CLAUDE_API_KEY" "LARK_APP_ID" "LARK_APP_SECRET" "TELEGRAM_BOT_TOKEN")
for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    echo "[ERROR] ç¼ºå°‘å¿…è¦ç¯å¢ƒå˜é‡: $var"
    exit 1
  fi
done

# æ£€æŸ¥API Keyæ ¼å¼ï¼ˆåŸºç¡€æ ¡éªŒï¼‰
if [[ ! $CLAUDE_API_KEY =~ ^sk-ant- ]]; then
  echo "[WARN] CLAUDE_API_KEY æ ¼å¼å¼‚å¸¸ï¼Œè¯·ç¡®è®¤"
fi

echo "=== å®‰å…¨æ£€æŸ¥é€šè¿‡ ==="
```

---

## 12. å¼€å‘é‡Œç¨‹ç¢‘

æœ¬é¡¹ç›®é‡‡ç”¨åŒçº¿å¹¶è¡Œå¼€å‘ç­–ç•¥ï¼ŒåŒæ—¶æ¨è¿›çˆ†æ¬¾é‡‡é›†å¹³å°å’Œ N8N å·¥ä½œæµã€‚

### Phase 1: åŸºç¡€è®¾æ–½ + é‡‡é›†æ ¸å¿ƒ

**ç›®æ ‡ï¼š** æ­å»ºåŸºç¡€è®¾æ–½ï¼Œå®ç°æ ¸å¿ƒé‡‡é›†åŠŸèƒ½

#### çˆ†æ¬¾é‡‡é›†å¹³å°

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| Next.js é¡¹ç›®åˆå§‹åŒ– | P0 | åŸºç¡€æ¡†æ¶æ­å»ºå®Œæˆ |
| PostgreSQL + Prisma é›†æˆ | P0 | æ•°æ®åº“å¯ç”¨ |
| Puppeteer é‡‡é›†å¼•æ“ | P0 | å…³é”®è¯æœç´¢é‡‡é›†å¯ç”¨ |
| BullMQ ä»»åŠ¡é˜Ÿåˆ— | P0 | å¼‚æ­¥ä»»åŠ¡å¤„ç†å¯ç”¨ |
| åŸºç¡€ UI å®ç° | P0 | çˆ†æ¬¾å‘ç°é¡µ + å†…å®¹åº“é¡µ |
| è´¦å· Cookie ç®¡ç† | P0 | Cookie å­˜å‚¨/è½®æ¢ |

#### N8N å·¥ä½œæµ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| Docker ç¯å¢ƒæ­å»º | P0 | N8N + æ•°æ®åº“éƒ¨ç½²å®Œæˆ |
| Claude API é…ç½® | P0 | API è°ƒç”¨æ­£å¸¸ |
| é£ä¹¦ API é…ç½® | P0 | æ•°æ®è¯»å†™æ­£å¸¸ |
| é€‰é¢˜ç”Ÿæˆå·¥ä½œæµ | P0 | content_generator_v1 |
| Telegram é€šçŸ¥ | P0 | é€šçŸ¥åŠŸèƒ½å¯ç”¨ |

**éªŒæ”¶æ ‡å‡†ï¼š**
- [ ] é‡‡é›†å¹³å°å¯é€šè¿‡å…³é”®è¯æœç´¢å¹¶é‡‡é›† 50+ ç¬”è®°
- [ ] é‡‡é›†æ•°æ®æ­£ç¡®å­˜å…¥ PostgreSQL
- [ ] N8N æˆåŠŸç”Ÿæˆ 10 ç¯‡å†…å®¹
- [ ] ä¸¤ç³»ç»Ÿ Docker Compose ä¸€é”®å¯åŠ¨

---

### Phase 2: åŠŸèƒ½å®Œå–„ + ç³»ç»Ÿé›†æˆ

**ç›®æ ‡ï¼š** å®Œå–„æ ¸å¿ƒåŠŸèƒ½ï¼Œå®ç°ä¸¤ç³»ç»Ÿé›†æˆ

#### çˆ†æ¬¾é‡‡é›†å¹³å°

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| ä½œè€…ç›‘æ§é‡‡é›† | P1 | è¿½è¸ªç‰¹å®šä½œè€… |
| å®šæ—¶é‡‡é›†ä»»åŠ¡ | P1 | è‡ªåŠ¨å®šæ—¶é‡‡é›† |
| æ•°æ®åˆ†æä»ªè¡¨ç›˜ | P1 | è¶‹åŠ¿å›¾è¡¨ + ç»Ÿè®¡ |
| æ”¶è—å¤¹åŠŸèƒ½ | P2 | å†…å®¹æ•´ç† |
| API æ¥å£å®Œå–„ | P0 | N8N å¯¹æ¥æ¥å£ |

#### N8N å·¥ä½œæµ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| çˆ†æ¬¾æ•°æ®æ‹‰å–å·¥ä½œæµ | P0 | hot_content_collector_v1 |
| AI å®¡æ ¸ 5 æ­¥æµç¨‹ | P0 | å®Œæ•´å®¡æ ¸é“¾è·¯ |
| é”™è¯¯å¤„ç† + é‡è¯• | P1 | è‡ªåŠ¨æ¢å¤æœºåˆ¶ |
| Prompt ä¼˜åŒ– | P1 | æå‡ç”Ÿæˆè´¨é‡ |

#### ç³»ç»Ÿé›†æˆ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| Webhook æ¥å£å®ç° | P0 | Web â†’ N8N æ•°æ®æ¨é€ |
| N8N HTTP è°ƒç”¨ | P0 | N8N â†’ Web æ•°æ®æ‹‰å– |
| é€‰é¢˜å‚è€ƒæ•°æ®æµ | P0 | çˆ†æ¬¾æ•°æ®ç”¨äºé€‰é¢˜ |

**éªŒæ”¶æ ‡å‡†ï¼š**
- [ ] é‡‡é›†å¹³å°æ—¥å‡é‡‡é›† â‰¥500 æ¡ç¬”è®°
- [ ] çˆ†æ¬¾è¯†åˆ«å‡†ç¡®ç‡ â‰¥80%
- [ ] N8N å¯ä» Web å¹³å°æ‹‰å–çˆ†æ¬¾æ•°æ®
- [ ] AI å®¡æ ¸é€šè¿‡ç‡ â‰¥85%
- [ ] 30 å¤©æŒç»­è¿è¡Œæ— é‡å¤§æ•…éšœ

---

### Phase 3: é«˜çº§åŠŸèƒ½ + ç”Ÿäº§å°±ç»ª

**ç›®æ ‡ï¼š** å®ç°é«˜çº§åŠŸèƒ½ï¼Œç³»ç»Ÿç”Ÿäº§å°±ç»ª

#### çˆ†æ¬¾é‡‡é›†å¹³å°

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| AI çˆ†æ¬¾é¢„æµ‹è¯„åˆ† | P2 | æ™ºèƒ½è¯„åˆ†åŠŸèƒ½ |
| AI é€‰é¢˜æ¨è | P2 | æ™ºèƒ½æ¨èåŠŸèƒ½ |
| å¯¼å‡ºåŠŸèƒ½ | P2 | CSV/JSON å¯¼å‡º |
| æ€§èƒ½ä¼˜åŒ– | P1 | å“åº”é€Ÿåº¦ä¼˜åŒ– |
| é”™è¯¯ç›‘æ§ | P1 | é‡‡é›†å¤±è´¥å‘Šè­¦ |

#### N8N å·¥ä½œæµ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸäº§å‡º |
|------|--------|----------|
| å›¾ç‰‡ç”Ÿæˆæ¨¡å— | P1 | Gemini é›†æˆ |
| å°çº¢ä¹¦ MCP å‘å¸ƒ | P1 | åŠè‡ªåŠ¨å‘å¸ƒ |
| å¤šè´¦å·ç®¡ç† | P1 | è´¦å·çŠ¶æ€æœº |
| é™é¢‘ç­–ç•¥ | P1 | å®‰å…¨å‘å¸ƒ |
| æ•°æ®å›æµåˆ†æ | P2 | çœŸå®è¯„åˆ†è®¡ç®— |

**éªŒæ”¶æ ‡å‡†ï¼š**
- [ ] é‡‡é›†å¹³å°ç¨³å®šè¿è¡Œ â‰¥90 å¤©
- [ ] é‡‡é›†æˆåŠŸç‡ â‰¥95%
- [ ] å›¾ç‰‡ç”ŸæˆæˆåŠŸç‡ â‰¥90%
- [ ] MCP å‘å¸ƒæˆåŠŸç‡ â‰¥95%
- [ ] æ”¯æŒ 3-5 ä¸ªè´¦å·å¹¶è¡Œå‘å¸ƒ
- [ ] AI è¯„åˆ†ä¸çœŸå®è¯„åˆ†è¯¯å·® <15

---

### å¼€å‘æ—¶é—´çº¿æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¼€å‘æ—¶é—´çº¿                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Phase 1: åŸºç¡€è®¾æ–½ + é‡‡é›†æ ¸å¿ƒ                                                â”‚
â”‚  â”œâ”€ çˆ†æ¬¾é‡‡é›†å¹³å°: Next.js + Puppeteer + PostgreSQL                          â”‚
â”‚  â””â”€ N8N å·¥ä½œæµ: åŸºç¡€ç¯å¢ƒ + é€‰é¢˜ç”Ÿæˆ                                          â”‚
â”‚                                                                              â”‚
â”‚  Phase 2: åŠŸèƒ½å®Œå–„ + ç³»ç»Ÿé›†æˆ                                                â”‚
â”‚  â”œâ”€ çˆ†æ¬¾é‡‡é›†å¹³å°: å®šæ—¶é‡‡é›† + æ•°æ®åˆ†æ + API                                  â”‚
â”‚  â”œâ”€ N8N å·¥ä½œæµ: AI å®¡æ ¸ + çˆ†æ¬¾æ‹‰å–                                           â”‚
â”‚  â””â”€ é›†æˆ: Webhook + HTTP è°ƒç”¨                                               â”‚
â”‚                                                                              â”‚
â”‚  Phase 3: é«˜çº§åŠŸèƒ½ + ç”Ÿäº§å°±ç»ª                                                â”‚
â”‚  â”œâ”€ çˆ†æ¬¾é‡‡é›†å¹³å°: AI è¯„åˆ† + é€‰é¢˜æ¨è                                         â”‚
â”‚  â””â”€ N8N å·¥ä½œæµ: å›¾ç‰‡ç”Ÿæˆ + MCP å‘å¸ƒ + æ•°æ®å›æµ                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é™„å½•

### A. æ•…éšœæ’æŸ¥SOP

#### é—®é¢˜ï¼šå†…å®¹ç”Ÿæˆå¤±è´¥

```
Step 1: å®šä½æ‰§è¡Œè®°å½•
â†’ N8N UI â†’ Executions â†’ ç­›é€‰å¤±è´¥ â†’ è®°å½•workflow_run_id

Step 2: æŸ¥çœ‹æ—¥å¿—
â†’ é£ä¹¦execution_logsè¡¨ â†’ æœç´¢workflow_run_id â†’ ç­›é€‰ERROR

Step 3: æ ¹å› åˆ†æ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”™è¯¯ç          â”‚ åŸå›           â”‚ è§£å†³æ–¹æ¡ˆ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RATE_LIMIT     â”‚ Claudeé™é¢‘    â”‚ ç­‰å¾…1miné‡è¯•    â”‚
â”‚ INVALID_PROMPT â”‚ Prompté”™è¯¯    â”‚ æ£€æŸ¥promptæ¨¡æ¿  â”‚
â”‚ TIMEOUT        â”‚ APIè¶…æ—¶       â”‚ å¢åŠ timeout     â”‚
â”‚ AUTH_FAILED    â”‚ è®¤è¯å¤±è´¥      â”‚ æ›´æ–°API Key     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: æ¢å¤è¿è¡Œ
â†’ ä¸´æ—¶é”™è¯¯ï¼šç‚¹å‡»ã€ŒRetry Executionã€
â†’ æ•°æ®é”™è¯¯ï¼šæ›´æ–°é£ä¹¦åé‡æ–°è§¦å‘
â†’ ä»£ç bugï¼šä¿®å¤workflowåé‡æ–°æ‰§è¡Œ
```

### B. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# Dockeræ“ä½œ
docker-compose up -d          # å¯åŠ¨æœåŠ¡
docker-compose down           # åœæ­¢æœåŠ¡
docker-compose logs -f n8n    # æŸ¥çœ‹æ—¥å¿—
docker-compose restart n8n    # é‡å¯N8N

# å¤‡ä»½æ¢å¤
./scripts/backup.sh           # æ‰§è¡Œå¤‡ä»½
./scripts/health_check.sh     # å¥åº·æ£€æŸ¥

# å·¥ä½œæµå¯¼å…¥å¯¼å‡º
docker exec n8n n8n export:workflow --all --output=/backups/all.json
docker exec n8n n8n import:workflow --input=/backups/all.json

# å›å½’æµ‹è¯•
./tests/regression/run_tests.sh                    # å…¨é‡æµ‹è¯•
./tests/regression/run_tests.sh content_generator  # æŒ‡å®šå·¥ä½œæµæµ‹è¯•
```

### C. æˆæœ¬ä¼°ç®—

| é¡¹ç›® | æœˆåº¦æˆæœ¬ |
|------|----------|
| äº‘æœåŠ¡å™¨(2æ ¸4G) | Â¥60-100 |
| Claude API | $50-150 |
| Gemini API | $20-50 |
| åŸŸå+SSL | Â¥10-20 |
| **æ€»è®¡** | **Â¥300-600** |

### D. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| SoT | Source of Truthï¼Œå•ä¸€å¯ä¿¡æ•°æ®æº |
| Workflow | N8Nä¸­çš„å·¥ä½œæµ |
| Node | N8Nå·¥ä½œæµä¸­çš„å•ä¸ªå¤„ç†èŠ‚ç‚¹ |
| Trigger | å·¥ä½œæµè§¦å‘å™¨ |
| MCP | Model Context Protocolï¼Œå°çº¢ä¹¦å‘å¸ƒåè®® |
| Golden Data | é‡‘æ•°æ®ï¼Œç”¨äºå›å½’æµ‹è¯•çš„å›ºå®šæµ‹è¯•ç”¨ä¾‹ |
| Prompt Registry | Promptæ³¨å†Œè¡¨ï¼Œç®¡ç†æ‰€æœ‰AI Promptçš„ç‰ˆæœ¬ |

---

## æ–‡æ¡£ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| v1.0 | 2024-12-11 | åˆå§‹ç‰ˆæœ¬ |
| v1.0-SoT | 2024-12-11 | å·¥ç¨‹åŒ–é‡æ„ï¼šæ–°å¢æ˜ å°„è¡¨ã€å·¥ä½œæµæ¸…å•ã€äº‹ä»¶æšä¸¾ã€Promptç‰ˆæœ¬ç®¡ç†ã€å›å½’æµ‹è¯•è§„èŒƒã€å®‰å…¨è§„èŒƒ |
| v2.0 | 2024-12-11 | æ¶æ„å‡çº§ï¼šæ–°å¢çˆ†æ¬¾é‡‡é›†å¹³å° (Next.js)ã€Monorepo æ¶æ„ã€PostgreSQL æ•°æ®åº“è®¾è®¡ã€Puppeteer é‡‡é›†å¼•æ“ã€BullMQ ä»»åŠ¡é˜Ÿåˆ—ã€åŒç³»ç»Ÿé›†æˆæ–¹æ¡ˆ |
| **v2.1** | 2025-12-12 | **å®Œå–„æ›´æ–°**ï¼šä¿®å¤ç« èŠ‚ç¼–å·é—®é¢˜ã€æ–°å¢ç¬¬10ç«  Chrome æ‰©å±•é›†æˆæŒ‡å—ã€å®Œå–„ç›®å½•ç»“æ„ã€ä¼˜åŒ–æ–‡æ¡£ä¸€è‡´æ€§ |

---

*æœ¬æ–‡æ¡£åŸºäºéœ€æ±‚æ–‡æ¡£v2.0ç¼–å†™ã€‚v2.1ç‰ˆæœ¬æ–°å¢Chromeæ‰©å±•é›†æˆæŒ‡å—ï¼Œé¡¹ç›®ç°åŒ…å«ä¸‰å¤§ç»„æˆéƒ¨åˆ†ï¼šçˆ†æ¬¾é‡‡é›†å¹³å°ã€N8Nå·¥ä½œæµå¼•æ“ã€Chromeæµè§ˆå™¨æ‰©å±•ã€‚*
